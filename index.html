<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesquisa de Satisfação e NPS</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Adicionado 'where' aqui

        // Global variables for Firebase (will be populated by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Export Firebase instances to be accessible in the main script
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.firebaseInitialAuthToken = initialAuthToken;
        window.firebaseAppId = appId;
        window.signInAnonymously = signInAnonymously;
        window.onAuthStateChanged = onAuthStateChanged;
        window.addDoc = addDoc;
        window.collection = collection;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.where = where; // Exportar 'where' também
        window.signInWithCustomToken = signInWithCustomToken;
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Fundo cinza claro */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alinha ao topo para melhor comportamento de rolagem */
            min-height: 100vh;
            padding: 2rem;
            overflow-x: hidden; /* Evita rolagem horizontal indesejada */
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 900px; /* Aumentado para acomodar mais conteúdo */
            width: 100%;
            text-align: center;
            position: relative; /* Para posicionar elementos flutuantes dentro */
            z-index: 10; /* Garante que o conteúdo principal esteja acima dos flutuantes */
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #22c55e; /* Fundo verde para sucesso */
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none; /* Escondido por padrão */
            font-weight: 600;
        }
        .error-message-box {
            background-color: #ef4444; /* Fundo vermelho para erro */
        }
        .star-icon {
            color: #f59e0b; /* Amarelo para as estrelas */
            font-size: 2.5rem;
            margin: 0 0.25rem;
        }
        .emoji-option {
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 2px solid transparent;
            border-radius: 9999px; /* Totalmente arredondado */
            padding: 0.5rem;
        }
        .emoji-option:hover {
            transform: translateY(-5px);
        }
        .emoji-option.selected {
            border-color: #3b82f6; /* Borda azul para selecionado */
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3); /* Brilho azul */
            transform: scale(1.05);
        }
        .emoji-icon {
            font-size: 3rem; /* Tamanho maior do emoji */
            line-height: 1;
        }
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }
        .radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db; /* Borda cinza */
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        .radio-option:hover {
            background-color: #f3f4f6;
        }
        .radio-option input[type="radio"] {
            margin-right: 0.5rem;
            accent-color: #3b82f6; /* Cor do rádio selecionado */
        }
        .nps-scale {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .nps-score-option {
            width: 3rem;
            height: 3rem;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: 600;
        }
        .nps-score-option:hover {
            background-color: #f3f4f6;
        }
        .nps-score-option.selected {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        /* Estilos e animações para elementos flutuantes */
        .floating-element {
            position: absolute;
            opacity: 0.3;
            animation: float 10s ease-in-out infinite;
            z-index: 1;
        }

        .floating-element.emoji {
            font-size: 4rem;
        }

        .floating-element:nth-child(1) {
            top: 10%;
            left: 5%;
            animation-delay: 0s;
        }
        .floating-element:nth-child(2) {
            top: 70%;
            left: 80%;
            animation-delay: 2s;
            animation-duration: 12s;
        }
        .floating-element:nth-child(3) {
            top: 20%;
            left: 90%;
            animation-delay: 4s;
            animation-duration: 9s;
        }
        .floating-element:nth-child(4) {
            top: 85%;
            left: 10%;
            animation-delay: 6s;
            animation-duration: 11s;
        }
        .floating-element:nth-child(5) {
            top: 40%;
            left: 45%;
            animation-delay: 1s;
            animation-duration: 10s;
        }

        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(10px, 20px) rotate(5deg); }
            50% { transform: translate(-10px, 0px) rotate(-5deg); }
            75% { transform: translate(5px, -15px) rotate(3deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        /* Estilos para a seção de edição */
        .edit-section {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 2rem;
            text-align: left;
        }
        .edit-option-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        .edit-option-item:last-child {
            border-bottom: none;
        }
        .admin-data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        .admin-data-table th, .admin-data-table td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
            font-size: 0.875rem;
        }
        .admin-data-table th {
            background-color: #f3f4f6;
            font-weight: 600;
        }
        .admin-data-table tbody tr:nth-child(odd) {
            background-color: #f9fafb;
        }
        .nps-gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 2rem;
            margin-bottom: 3rem;
        }
        .nps-gauge {
            width: 100%;
            max-width: 400px;
            height: 20px;
            background: linear-gradient(to right, #ef4444 0%, #f97316 50%, #22c55e 100%); /* Red to Orange to Green */
            border-radius: 9999px;
            position: relative;
            margin-bottom: 1rem;
        }
        .nps-pointer {
            position: absolute;
            top: -10px; /* Adjust to center vertically on the bar */
            width: 20px;
            height: 40px;
            background-color: white;
            border: 2px solid #3b82f6; /* Blue border */
            border-radius: 50%;
            transform: translateX(-50%); /* Center the pointer */
            transition: left 0.5s ease-in-out;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: #3b82f6;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .nps-score-display {
            font-size: 3rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .nps-meta {
            font-size: 1.25rem;
            color: #4b5563;
        }
    </style>
</head>
<body>
    <!-- Elementos flutuantes -->
    <div class="floating-element emoji">✨</div>
    <div class="floating-element emoji">🚀</div>
    <div class="floating-element emoji">💡</div>
    <div class="floating-element emoji">🌟</div>
    <div class="floating-element emoji">👍</div>

    <div class="container">
        <!-- Página Inicial (Carinhas de Satisfação) -->
        <div id="initialPage">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Sua Opinião é Valiosa!</h1>
            <p class="text-gray-600 mb-8">Como você avaliaria sua experiência e satisfação?</p>

            <div class="flex justify-center items-end gap-6 mb-10 flex-wrap">
                <!-- Emojis para níveis de satisfação -->
                <div class="emoji-option" data-value="Excelente">
                    <span class="emoji-icon">😊</span>
                    <p class="text-sm font-medium text-gray-700 mt-2">Excelente</p>
                </div>
                <div class="emoji-option" data-value="Bom">
                    <span class="emoji-icon">🙂</span>
                    <p class="text-sm font-medium text-gray-700 mt-2">Bom</p>
                </div>
                <div class="emoji-option" data-value="Regular">
                    <span class="emoji-icon">😐</span>
                    <p class="text-sm font-medium text-gray-700 mt-2">Regular</p>
                </div>
                <div class="emoji-option" data-value="Ruim">
                    <span class="emoji-icon">🙁</span>
                    <p class="text-sm font-medium text-gray-700 mt-2">Ruim</p>
                </div>
                <div class="emoji-option" data-value="Péssimo">
                    <span class="emoji-icon">😠</span>
                    <p class="text-sm font-medium text-gray-700 mt-2">Péssimo</p>
                </div>
            </div>

            <button id="continueBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300">
                Continuar para a Pesquisa
            </button>
            <button id="goToAdminBtn" class="w-full mt-4 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-gray-500">
                Acessar Painel Admin
            </button>
        </div>

        <!-- Página da Pesquisa de NPS (inicialmente escondida) -->
        <div id="npsPage" style="display: none;">
            <!-- Estrelas conforme a imagem -->
            <div class="flex justify-center mb-4">
                <span class="star-icon">★</span>
                <span class="star-icon">★</span>
                <span class="star-icon">★</span>
            </div>

            <h1 class="text-3xl font-bold text-gray-800 mb-2">Pesquisa de Satisfação</h1>
            <p class="text-gray-600 mb-8">Estamos abertos a ouvir sua opinião e sempre buscar melhorias em nossos serviços. Participe!</p>

            <!-- 1. Sua necessidade foi resolvida? -->
            <div class="mb-6 text-left">
                <p class="text-gray-700 text-lg font-medium mb-3">1. Sua necessidade foi resolvida?</p>
                <div class="radio-group justify-start">
                    <label class="radio-option">
                        <input type="radio" name="necessidadeResolvida" value="Sim" class="form-radio">
                        Sim
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="necessidadeResolvida" value="Não" class="form-radio">
                        Não
                    </label>
                </div>
            </div>

            <!-- 2. Você classificaria seu retorno como: -->
            <div class="mb-6 text-left">
                <p class="text-gray-700 text-lg font-medium mb-3">2. Você classificaria seu retorno como:</p>
                <div class="radio-group justify-start">
                    <label class="radio-option">
                        <input type="radio" name="tipoRetorno" value="Elogio" class="form-radio">
                        Elogio
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="tipoRetorno" value="Sugestão de Melhoria" class="form-radio">
                        Sugestão de Melhoria
                    </label>
                </div>
            </div>

            <!-- 3. Em uma escala de 0 a 10, qual a probabilidade de você recomendar nosso serviço a um amigo ou colega? (NPS) -->
            <div class="mb-6 text-left">
                <p class="text-gray-700 text-lg font-medium mb-3">3. Em uma escala de 0 a 10, qual a probabilidade de você recomendar nosso serviço a um amigo ou colega?</p>
                <div class="nps-scale">
                    <!-- Scores 0-10 -->
                    <div class="nps-score-option" data-score="0">0</div>
                    <div class="nps-score-option" data-score="1">1</div>
                    <div class="nps-score-option" data-score="2">2</div>
                    <div class="nps-score-option" data-score="3">3</div>
                    <div class="nps-score-option" data-score="4">4</div>
                    <div class="nps-score-option" data-score="5">5</div>
                    <div class="nps-score-option" data-score="6">6</div>
                    <div class="nps-score-option" data-score="7">7</div>
                    <div class="nps-score-option" data-score="8">8</div>
                    <div class="nps-score-option" data-score="9">9</div>
                    <div class="nps-score-option" data-score="10">10</div>
                </div>
            </div>

            <!-- 4. Sinalize o principal ponto motivador da sua resposta: -->
            <div class="mb-8 text-left">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-gray-700 text-lg font-medium">4. Sinalize o principal ponto motivador da sua resposta:</p>
                    <button id="editMotivatorsBtn" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded-md transition duration-200">
                        Editar Opções
                    </button>
                </div>
                <div id="motivatorOptionsContainer" class="radio-group justify-start">
                    <!-- Opções serão carregadas aqui via JavaScript -->
                </div>
            </div>

            <!-- Seção de Edição de Motivadores (inicialmente escondida) -->
            <div id="editMotivatorsSection" class="edit-section hidden">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Editar Opções de Motivadores</h3>
                <div id="currentMotivatorOptions" class="mb-4">
                    <!-- Opções atuais para edição -->
                </div>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="newMotivatorInput" class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Adicionar nova opção">
                    <button id="addMotivatorBtn" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md transition duration-200">
                        Adicionar
                    </button>
                </div>
                <button id="saveMotivatorsBtn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Salvar Edições
                </button>
            </div>

            <!-- 5. Comente seu apontamento (opcional): -->
            <div class="mb-8 text-left">
                <label for="comments" class="block text-gray-700 text-lg font-medium mb-2">5. Comente seu apontamento (opcional):</label>
                <textarea id="comments" rows="5" class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" placeholder="Seu comentário aqui..."></textarea>
            </div>

            <button id="submitBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-yellow-300">
                <span class="mr-2">✉️</span> Enviar Resposta
            </button>
        </div>

        <!-- Página de Login do Admin (inicialmente escondida) -->
        <div id="adminLoginPage" style="display: none;">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Acesso Administrativo</h1>
            <p class="text-gray-600 mb-8">Por favor, insira a senha para acessar o painel.</p>
            <input type="password" id="adminPasswordInput" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" placeholder="Senha">
            <button id="adminLoginBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                Entrar
            </button>
            <button id="backToInitialFromAdminLogin" class="w-full mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-gray-300">
                Voltar
            </button>
        </div>

        <!-- Painel Admin (inicialmente escondido) -->
        <div id="adminDashboardPage" style="display: none;">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Feedbacks e NPS</h1>
            <p class="text-gray-600 mb-8">Acompanhe a satisfação dos seus pacientes.</p>

            <!-- Net Promoter Score (NPS) Section for Admin -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Net Promoter Score (NPS)</h2>
                    <select id="npsPeriodSelect" class="p-2 border border-gray-300 rounded-md">
                        <option value="all">Todo o período</option>
                        <option value="7days">Últimos 7 dias</option>
                        <option value="30days">Últimos 30 dias</option>
                    </select>
                </div>

                <div class="nps-gauge-container">
                    <div class="nps-gauge">
                        <div id="adminNpsPointer" class="nps-pointer">0</div>
                    </div>
                    <div id="adminNpsScoreDisplay" class="nps-score-display">0</div>
                    <div class="nps-meta">Meta: 90</div>
                </div>
            </div>

            <!-- Base de Feedbacks Section for Admin -->
            <div>
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Base de Feedbacks</h2>
                <p class="text-gray-600 mb-4">Todos os feedbacks recebidos no período selecionado.</p>

                <div class="overflow-x-auto">
                    <table class="admin-data-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>ID do Usuário</th>
                                <th>Avaliação Inicial</th>
                                <th>Resolvido?</th>
                                <th>Tipo</th>
                                <th>Nota NPS</th>
                                <th>Motivador</th>
                                <th>Comentário</th>
                            </tr>
                        </thead>
                        <tbody id="surveyResultsBody">
                            <!-- Dados da pesquisa serão carregados aqui -->
                            <tr><td colspan="8" class="text-center text-gray-500">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <button id="backToInitialFromAdminDashboard" class="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-gray-300">
                Voltar
            </button>
        </div>
    </div>

    <!-- Message Box for confirmation/error -->
    <div id="messageBox" class="message-box">
        <!-- O conteúdo da mensagem será definido pelo JavaScript -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Firebase instances from global window object
            const app = window.firebaseApp;
            const db = window.firebaseDb;
            const auth = window.firebaseAuth;
            const initialAuthToken = window.firebaseInitialAuthToken;
            const appId = window.firebaseAppId;
            const signInAnonymously = window.signInAnonymously;
            const onAuthStateChanged = window.onAuthStateChanged;
            const addDoc = window.addDoc;
            const collection = window.collection;
            const onSnapshot = window.onSnapshot;
            const query = window.query;
            const where = window.where; // Importado 'where'
            const signInWithCustomToken = window.signInWithCustomToken;

            // UI Elements
            const initialPage = document.getElementById('initialPage');
            const npsPage = document.getElementById('npsPage');
            const adminLoginPage = document.getElementById('adminLoginPage');
            const adminDashboardPage = document.getElementById('adminDashboardPage');

            const emojiOptions = document.querySelectorAll('.emoji-option');
            const continueBtn = document.getElementById('continueBtn');
            const goToAdminBtn = document.getElementById('goToAdminBtn');
            const npsScoreOptions = document.querySelectorAll('.nps-score-option');
            const submitBtn = document.getElementById('submitBtn');
            const commentsTextArea = document.getElementById('comments');
            const messageBox = document.getElementById('messageBox');

            const editMotivatorsBtn = document.getElementById('editMotivatorsBtn');
            const editMotivatorsSection = document.getElementById('editMotivatorsSection');
            const newMotivatorInput = document.getElementById('newMotivatorInput');
            const addMotivatorBtn = document.getElementById('addMotivatorBtn');
            const saveMotivatorsBtn = document.getElementById('saveMotivatorsBtn');
            const currentMotivatorOptionsDiv = document.getElementById('currentMotivatorOptions');
            const motivatorOptionsContainer = document.getElementById('motivatorOptionsContainer');

            const adminPasswordInput = document.getElementById('adminPasswordInput');
            const adminLoginBtn = document.getElementById('adminLoginBtn');
            const surveyResultsBody = document.getElementById('surveyResultsBody');
            const adminNpsPointer = document.getElementById('adminNpsPointer');
            const adminNpsScoreDisplay = document.getElementById('adminNpsScoreDisplay');
            const npsPeriodSelect = document.getElementById('npsPeriodSelect');
            const backToInitialFromAdminLogin = document.getElementById('backToInitialFromAdminLogin');
            const backToInitialFromAdminDashboard = document.getElementById('backToInitialFromAdminDashboard');


            // State variables
            let selectedInitialRating = null;
            let selectedNPSScore = null;
            let motivatorOptions = JSON.parse(localStorage.getItem('motivatorOptions')) || ["Atendimento", "Comunicação", "Cumprimento de prazos", "Transparência"];
            let currentUserId = null;
            let isAuthReady = false;

            // --- Firebase Authentication ---
            // Sign in anonymously for general survey users
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log("Usuário autenticado:", currentUserId);
                } else {
                    console.log("Nenhum usuário autenticado.");
                    currentUserId = crypto.randomUUID(); // Fallback for unauthenticated
                }
                isAuthReady = true;
            });

            // --- Utility Functions ---
            // Função para exibir mensagem (sucesso/erro)
            function showMessage(message, isError = false) {
                messageBox.textContent = message;
                messageBox.classList.remove('bg-green-500', 'bg-red-500');
                if (isError) {
                    messageBox.classList.add('bg-red-500');
                } else {
                    messageBox.classList.add('bg-green-500');
                }
                messageBox.style.display = 'block';
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 3000);
            }

            // Função para renderizar as opções de motivadores
            function renderMotivatorOptions() {
                motivatorOptionsContainer.innerHTML = ''; // Limpa as opções existentes
                motivatorOptions.forEach(option => {
                    const label = document.createElement('label');
                    label.className = 'radio-option';
                    label.innerHTML = `
                        <input type="radio" name="pontoMotivador" value="${option}" class="form-radio">
                        ${option}
                    `;
                    motivatorOptionsContainer.appendChild(label);
                });
            }

            // Função para renderizar as opções de motivadores na seção de edição
            function renderEditMotivatorOptions() {
                currentMotivatorOptionsDiv.innerHTML = '';
                if (motivatorOptions.length === 0) {
                    currentMotivatorOptionsDiv.innerHTML = '<p class="text-gray-500">Nenhuma opção adicionada ainda.</p>';
                    return;
                }
                motivatorOptions.forEach((option, index) => {
                    const div = document.createElement('div');
                    div.className = 'edit-option-item';
                    div.innerHTML = `
                        <span>${option}</span>
                        <button data-index="${index}" class="remove-motivator-btn bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded-md transition duration-200">Remover</button>
                    `;
                    currentMotivatorOptionsDiv.appendChild(div);
                });

                // Adiciona listeners para os botões de remover
                document.querySelectorAll('.remove-motivator-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const index = parseInt(event.target.dataset.index);
                        motivatorOptions.splice(index, 1);
                        renderEditMotivatorOptions(); // Re-renderiza a lista de edição
                        renderMotivatorOptions(); // Re-renderiza a lista principal
                        localStorage.setItem('motivatorOptions', JSON.stringify(motivatorOptions));
                    });
                });
            }

            // Função para atualizar o medidor de NPS no painel admin
            function updateNPSGauge(score) {
                // Clamp score between -100 and 100
                score = Math.max(-100, Math.min(100, score));

                // Calculate position (0% for -100, 100% for 100)
                const position = ((score + 100) / 200) * 100; // Convert to percentage

                adminNpsPointer.style.left = `${position}%`;
                adminNpsPointer.textContent = score;
                adminNpsScoreDisplay.textContent = score;
            }

            // Função para carregar e exibir os dados da pesquisa
            function loadSurveyData(period = 'all') {
                if (!isAuthReady) {
                    console.log("Autenticação não pronta, tentando novamente em breve...");
                    setTimeout(() => loadSurveyData(period), 500); // Retry after 500ms
                    return;
                }

                surveyResultsBody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500">Carregando dados...</td></tr>';
                try {
                    let q = collection(db, `/artifacts/${appId}/public/data/surveyResponses`);

                    // Filter by period
                    if (period === '7days') {
                        const sevenDaysAgo = new Date();
                        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                        q = query(q, where('timestamp', '>=', sevenDaysAgo));
                    } else if (period === '30days') {
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        q = query(q, where('timestamp', '>=', thirtyDaysAgo));
                    }

                    // Using onSnapshot for real-time updates
                    onSnapshot(q, (snapshot) => {
                        surveyResultsBody.innerHTML = ''; // Clear existing data
                        const feedbacks = [];
                        let promoters = 0;
                        let detractors = 0;
                        let totalResponses = 0;

                        if (snapshot.empty) {
                            surveyResultsBody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500">Nenhum dado de pesquisa encontrado.</td></tr>';
                            updateNPSGauge(0); // Reset NPS if no data
                            return;
                        }
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            feedbacks.push({
                                id: doc.id, // Include document ID for potential future use
                                date: data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'N/A',
                                userId: data.userId || 'N/A',
                                initialRating: data.initialRating || 'N/A',
                                resolved: data.necessidadeResolvida || 'N/A',
                                type: data.tipoRetorno || 'N/A',
                                npsScore: data.npsScore !== undefined ? data.npsScore : 'N/A',
                                motivator: data.pontoMotivador || 'N/A',
                                comment: data.comments || 'N/A'
                            });

                            // Calculate NPS
                            if (data.npsScore !== undefined) {
                                if (data.npsScore >= 9) {
                                    promoters++;
                                } else if (data.npsScore <= 6) {
                                    detractors++;
                                }
                                totalResponses++;
                            }
                        });

                        // Populate the table
                        feedbacks.forEach(feedback => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${feedback.date}</td>
                                <td>${feedback.userId}</td>
                                <td>${feedback.initialRating}</td>
                                <td>${feedback.resolved}</td>
                                <td>${feedback.type}</td>
                                <td>${feedback.npsScore}</td>
                                <td>${feedback.motivator}</td>
                                <td>${feedback.comment}</td>
                            `;
                            surveyResultsBody.appendChild(row);
                        });

                        // Update NPS Gauge
                        if (totalResponses > 0) {
                            const nps = ((promoters - detractors) / totalResponses) * 100;
                            updateNPSGauge(Math.round(nps));
                        } else {
                            updateNPSGauge(0); // No data, NPS is 0
                        }

                    }, (error) => {
                        console.error("Erro ao carregar dados do Firestore:", error);
                        surveyResultsBody.innerHTML = '<tr><td colspan="8" class="text-center text-red-500">Erro ao carregar dados.</td></tr>';
                        showMessage('Erro ao carregar dados do painel de administração.', true);
                    });
                } catch (error) {
                    console.error("Erro ao configurar listener do Firestore:", error);
                    surveyResultsBody.innerHTML = '<tr><td colspan="8" class="text-center text-red-500">Erro ao iniciar o carregamento de dados.</td></tr>';
                    showMessage('Erro ao iniciar o carregamento de dados do painel de administração.', true);
                }
            }


            // --- Initial Setup ---
            renderMotivatorOptions(); // Carrega as opções de motivadores ao iniciar

            // --- Event Listeners ---
            // Adiciona listener de clique para cada opção de emoji
            emojiOptions.forEach(option => {
                option.addEventListener('click', () => {
                    emojiOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedInitialRating = option.dataset.value;
                });
            });

            // Adiciona listener de clique ao botão 'Continuar' (da página inicial para NPS)
            continueBtn.addEventListener('click', () => {
                if (selectedInitialRating) {
                    initialPage.style.display = 'none';
                    npsPage.style.display = 'block';
                    console.log('Avaliação inicial selecionada:', selectedInitialRating);
                } else {
                    showMessage('Por favor, selecione uma opção antes de continuar.', true);
                }
            });

            // Adiciona listener de clique ao botão 'Acessar Painel Admin'
            goToAdminBtn.addEventListener('click', () => {
                initialPage.style.display = 'none';
                adminLoginPage.style.display = 'block';
                adminPasswordInput.value = ''; // Limpa o campo da senha
            });

            // Adiciona listener de clique ao botão 'Voltar' da página de login do admin
            backToInitialFromAdminLogin.addEventListener('click', () => {
                adminLoginPage.style.display = 'none';
                initialPage.style.display = 'block';
            });

            // Adiciona listener de clique ao botão 'Voltar' do painel do admin
            backToInitialFromAdminDashboard.addEventListener('click', () => {
                adminDashboardPage.style.display = 'none';
                initialPage.style.display = 'block';
            });

            // Adiciona listener de clique para cada opção de pontuação NPS
            npsScoreOptions.forEach(option => {
                option.addEventListener('click', () => {
                    npsScoreOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedNPSScore = parseInt(option.dataset.score);
                });
            });

            // Lógica para o botão "Editar Opções"
            editMotivatorsBtn.addEventListener('click', () => {
                editMotivatorsSection.classList.toggle('hidden');
                renderEditMotivatorOptions(); // Renderiza as opções para edição
            });

            // Lógica para adicionar nova opção de motivador
            addMotivatorBtn.addEventListener('click', () => {
                const newValue = newMotivatorInput.value.trim();
                if (newValue && !motivatorOptions.includes(newValue)) {
                    motivatorOptions.push(newValue);
                    newMotivatorInput.value = '';
                    renderEditMotivatorOptions(); // Re-renderiza a lista de edição
                    renderMotivatorOptions(); // Re-renderiza a lista principal
                    localStorage.setItem('motivatorOptions', JSON.stringify(motivatorOptions));
                } else if (newValue && motivatorOptions.includes(newValue)) {
                    showMessage('Esta opção já existe.', true);
                } else {
                    showMessage('Por favor, digite uma opção válida.', true);
                }
            });

            // Lógica para salvar edições (esconde a seção de edição)
            saveMotivatorsBtn.addEventListener('click', () => {
                editMotivatorsSection.classList.add('hidden');
                showMessage('Opções de motivadores salvas!', false);
            });

            // Adiciona listener de clique ao botão 'Enviar Resposta' (da pesquisa NPS)
            submitBtn.addEventListener('click', async () => {
                const necessidadeResolvida = document.querySelector('input[name="necessidadeResolvida"]:checked')?.value;
                const tipoRetorno = document.querySelector('input[name="tipoRetorno"]:checked')?.value;
                const pontoMotivador = document.querySelector('input[name="pontoMotivador"]:checked')?.value;
                const comments = commentsTextArea.value.trim();

                if (selectedNPSScore === null || !necessidadeResolvida || !tipoRetorno || !pontoMotivador) {
                    showMessage('Por favor, preencha todos os campos obrigatórios antes de enviar.', true);
                    return;
                }

                const surveyData = {
                    userId: currentUserId,
                    initialRating: selectedInitialRating,
                    necessidadeResolvida: necessidadeResolvida,
                    tipoRetorno: tipoRetorno,
                    npsScore: selectedNPSScore,
                    pontoMotivador: pontoMotivador,
                    comments: comments,
                    timestamp: new Date() // Adiciona um timestamp
                };

                try {
                    if (isAuthReady) {
                        await addDoc(collection(db, `/artifacts/${appId}/public/data/surveyResponses`), surveyData);
                        console.log('Dados da Pesquisa salvos no Firestore:', surveyData);
                        showMessage('Avaliação enviada com sucesso!');
                    } else {
                        showMessage('Erro: Autenticação não pronta. Tente novamente.', true);
                        console.error('Erro: Autenticação Firebase não pronta.');
                        return;
                    }
                } catch (e) {
                    console.error("Erro ao adicionar documento: ", e);
                    showMessage('Erro ao enviar avaliação. Tente novamente.', true);
                    return;
                }

                // Reseta o formulário (opcional)
                npsScoreOptions.forEach(opt => opt.classList.remove('selected'));
                document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
                commentsTextArea.value = '';
                selectedNPSScore = null;
                selectedInitialRating = null; // Reseta a seleção inicial também

                // Opcional: Voltar para a página inicial após o envio
                setTimeout(() => {
                    npsPage.style.display = 'none';
                    initialPage.style.display = 'block';
                    emojiOptions.forEach(opt => opt.classList.remove('selected')); // Limpa seleção de emoji
                }, 3000);
            });

            // Lógica de login do Admin
            adminLoginBtn.addEventListener('click', () => {
                const password = adminPasswordInput.value;
                const correctPassword = "123"; // Senha hardcoded

                if (password === correctPassword) {
                    adminLoginPage.style.display = 'none';
                    adminDashboardPage.style.display = 'block';
                    loadSurveyData(npsPeriodSelect.value); // Carrega os dados da pesquisa com o período selecionado
                } else {
                    showMessage('Senha incorreta. Tente novamente.', true);
                    adminPasswordInput.value = ''; // Limpa o campo da senha
                }
            });

            // Listener para o filtro de período no painel admin
            npsPeriodSelect.addEventListener('change', (event) => {
                loadSurveyData(event.target.value);
            });
        });
    </script>
</body>
</html>
