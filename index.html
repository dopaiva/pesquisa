<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesquisa de Satisfação e NPS</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase (will be populated by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Export Firebase instances to be accessible in the main script
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.firebaseInitialAuthToken = initialAuthToken;
        window.firebaseAppId = appId;
        window.signInAnonymously = signInAnonymously;
        window.onAuthStateChanged = onAuthStateChanged;
        window.addDoc = addDoc;
        window.collection = collection;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.where = where;
        window.signInWithCustomToken = signInWithCustomToken;
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Fundo cinza claro */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alinha ao topo para melhor comportamento de rolagem */
            min-height: 100vh;
            padding: 2rem;
            overflow-x: hidden; /* Evita rolagem horizontal indesejada */
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 900px; /* Aumentado para acomodar mais conteúdo */
            width: 100%;
            text-align: center;
            position: relative; /* Para posicionar elementos flutuantes dentro */
            z-index: 10; /* Garante que o conteúdo principal esteja acima dos flutuantes */
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #22c55e; /* Fundo verde para sucesso */
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none; /* Escondido por padrão */
            font-weight: 600;
        }
        .error-message-box {
            background-color: #ef4444; /* Fundo vermelho para erro */
        }
        .star-icon {
            color: #f59e0b; /* Amarelo para as estrelas */
            font-size: 2.5rem;
            margin: 0 0.25rem;
        }
        .emoji-option {
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 2px solid transparent;
            border-radius: 9999px; /* Totalmente arredondado */
            padding: 0.5rem;
        }
        .emoji-option:hover {
            transform: translateY(-5px);
        }
        .emoji-option.selected {
            border-color: #3b82f6; /* Borda azul para selecionado */
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3); /* Brilho azul */
            transform: scale(1.05);
        }
        .emoji-icon {
            font-size: 3rem; /* Tamanho maior do emoji */
            line-height: 1;
        }
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }
        .radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db; /* Borda cinza */
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        .radio-option:hover {
            background-color: #f3f4f6;
        }
        .radio-option input[type="radio"] {
            margin-right: 0.5rem;
            accent-color: #3b82f6; /* Cor do rádio selecionado */
        }
        .nps-scale {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .nps-score-option {
            width: 3rem;
            height: 3rem;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: 600;
        }
        .nps-score-option.selected {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        /* Estilos e animações para elementos flutuantes */
        .floating-element {
            position: absolute;
            opacity: 0.7; /* Mais visível */
            animation: float 10s ease-in-out infinite;
            z-index: 1;
        }

        .floating-element.emoji {
            font-size: 4rem;
        }

        .floating-element:nth-child(1) {
            top: 10%;
            left: 5%;
            animation-delay: 0s;
        }
        .floating-element:nth-child(2) {
            top: 70%;
            left: 80%;
            animation-delay: 2s;
            animation-duration: 12s;
        }
        .floating-element:nth-child(3) {
            top: 20%;
            left: 90%;
            animation-delay: 4s;
            animation-duration: 9s;
        }
        .floating-element:nth-child(4) {
            top: 85%;
            left: 10%;
            animation-delay: 6s;
            animation-duration: 11s;
        }
        .floating-element:nth-child(5) {
            top: 40%;
            left: 45%;
            animation-delay: 1s;
            animation-duration: 10s;
        }

        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(10px, 20px) rotate(5deg); }
            50% { transform: translate(-10px, 0px) rotate(-5deg); }
            75% { transform: translate(5px, -15px) rotate(3deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        /* Estilos para a seção de edição */
        .edit-section {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 2rem;
            text-align: left;
        }
        .edit-option-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        .edit-option-item:last-child {
            border-bottom: none;
        }
        .admin-data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        .admin-data-table th, .admin-data-table td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
            font-size: 0.875rem;
        }
        .admin-data-table th {
            background-color: #f3f4f6;
            font-weight: 600;
        }
        .admin-data-table tbody tr:nth-child(odd) {
            background-color: #f9fafb;
        }
        .nps-gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 2rem;
            margin-bottom: 3rem;
        }
        .nps-gauge {
            width: 100%;
            max-width: 400px;
            height: 20px;
            background: linear-gradient(to right, #ef4444 0%, #f97316 50%, #22c55e 100%); /* Red to Orange to Green */
            border-radius: 9999px;
            position: relative;
            margin-bottom: 1rem;
        }
        .nps-pointer {
            position: absolute;
            top: -10px; /* Adjust to center vertically on the bar */
            width: 20px;
            height: 40px;
            background-color: white;
            border: 2px solid #3b82f6; /* Blue border */
            border-radius: 50%;
            transform: translateX(-50%); /* Center the pointer */
            transition: left 0.5s ease-in-out;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: #3b82f6;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .nps-score-display {
            font-size: 3rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .nps-meta {
            font-size: 1.25rem;
            color: #4b5563;
        }

        /* Estilos para botões flutuantes de ação */
        .floating-action-buttons-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 50; /* Acima dos elementos flutuantes, mas abaixo das mensagens */
        }
        .floating-button {
            width: 50px; /* Tamanho fixo para ser redondo */
            height: 50px; /* Tamanho fixo para ser redondo */
            border-radius: 50%; /* Faz o botão ser um círculo perfeito */
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none; /* Para o link do WhatsApp */
            color: white;
            font-size: 1.5rem; /* Tamanho maior para o ícone */
        }
        .floating-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        .floating-button.admin {
            background-color: #6b7280; /* Cinza escuro */
            color: white;
        }
        .floating-button.admin:hover {
            background-color: #4b5563;
        }
        .floating-button.whatsapp {
            background-color: #25D366; /* Verde WhatsApp */
            color: white;
        }
        .floating-button.whatsapp:hover {
            background-color: #1DA851;
        }

        /* Estilos para gráficos de barra */
        .chart-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background-color: #f9fafb;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            text-align: left;
        }
        .chart-bar-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .chart-bar-label {
            width: 120px; /* Largura fixa para rótulos */
            font-size: 0.875rem;
            color: #4b5563;
            flex-shrink: 0;
        }
        .chart-bar-bg {
            flex-grow: 1;
            height: 20px;
            background-color: #e5e7eb;
            border-radius: 0.25rem;
            overflow: hidden;
        }
        .chart-bar-fill {
            height: 100%;
            background-color: #3b82f6; /* Cor da barra */
            border-radius: 0.25rem;
            transition: width 0.5s ease-out;
        }
        .chart-bar-value {
            margin-left: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #1f2937;
        }
    </style>
</head>
<body>
    <!-- Elementos flutuantes -->
    <div class="floating-element emoji">✨</div>
    <div class="floating-element emoji">🚀</div>
    <div class="floating-element emoji">💡</div>
    <div class="floating-element emoji">🌟</div>
    <div class="floating-element emoji">👍</div>

    <div class="container">
        <!-- Página Inicial (Carinhas de Satisfação) -->
        <div id="initialPage">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Sua Opinião é Valiosa!</h1>
            <p class="text-gray-600 mb-8">Como você avaliaria sua experiência e satisfação?</p>

            <div class="flex justify-center items-end gap-6 mb-10 flex-wrap">
                <!-- Emojis para níveis de satisfação -->
                <div class="emoji-option" data-value="Excelente">
                    <span class="emoji-icon">😊</span>
                    <p class="text-sm font-medium text-gray-700 mt-2">Excelente</p>
                </div>
                <div class="emoji-option" data-value="Bom">
                    <span class="emoji-icon">🙂</span>
                    <p class="text-sm font-medium text-gray-700 mt-2">Bom</p>
                </div>
                <div class="emoji-option" data-value="Regular">
                    <span class="emoji-icon">😐</span>
                    <p class="text-sm font-medium text-gray-700 mt-2">Regular</p>
                </div>
                <div class="emoji-option" data-value="Ruim">
                    <span class="emoji-icon">🙁</span>
                    <p class="text-sm font-medium text-gray-700 mt-2">Ruim</p>
                </div>
                <div class="emoji-option" data-value="Péssimo">
                    <span class="emoji-icon">😠</span>
                    <p class="text-sm font-medium text-gray-700 mt-2">Péssimo</p>
                </div>
            </div>
        </div>

        <!-- Página de Detalhes da Pesquisa (inicialmente escondida) -->
        <div id="detailSurveyPage" style="display: none;">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Detalhes da Sua Experiência</h1>
            <p class="text-gray-600 mb-8">Conte-nos mais sobre sua experiência para nos ajudar a melhorar.</p>

            <!-- 1. Sua necessidade foi resolvida? -->
            <div class="mb-6 text-left">
                <p class="text-gray-700 text-lg font-medium mb-3">1. Sua necessidade foi resolvida?</p>
                <div class="radio-group justify-start">
                    <label class="radio-option">
                        <input type="radio" name="necessidadeResolvida" value="Sim" class="form-radio">
                        Sim
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="necessidadeResolvida" value="Não" class="form-radio">
                        Não
                    </label>
                </div>
            </div>

            <!-- 2. Você classificaria seu retorno como: -->
            <div class="mb-6 text-left">
                <p class="text-gray-700 text-lg font-medium mb-3">2. Você classificaria seu retorno como:</p>
                <div class="radio-group justify-start">
                    <label class="radio-option">
                        <input type="radio" name="tipoRetorno" value="Elogio" class="form-radio">
                        Elogio
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="tipoRetorno" value="Sugestão de Melhoria" class="form-radio">
                        Sugestão de Melhoria
                    </label>
                </div>
            </div>

            <!-- Nova Pergunta: Faixa Etária -->
            <div class="mb-6 text-left">
                <p class="text-gray-700 text-lg font-medium mb-3">3. Qual a sua faixa etária?</p>
                <div class="radio-group justify-start">
                    <label class="radio-option">
                        <input type="radio" name="ageRange" value="Menos de 18" class="form-radio">
                        Menos de 18
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="ageRange" value="18-24" class="form-radio">
                        18-24
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="ageRange" value="25-34" class="form-radio">
                        25-34
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="ageRange" value="35-44" class="form-radio">
                        35-44
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="ageRange" value="45-54" class="form-radio">
                        45-54
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="ageRange" value="55-64" class="form-radio">
                        55-64
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="ageRange" value="65 ou mais" class="form-radio">
                        65 ou mais
                    </label>
                </div>
            </div>

            <!-- 4. Sinalize o principal ponto motivador da sua resposta: -->
            <div class="mb-8 text-left">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-gray-700 text-lg font-medium">4. Sinalize o principal ponto motivador da sua resposta:</p>
                    <button id="editMotivatorsBtn" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded-md transition duration-200">
                        Editar Opções
                    </button>
                </div>
                <div id="motivatorOptionsContainer" class="radio-group justify-start">
                    <!-- Opções serão carregadas aqui via JavaScript -->
                </div>
            </div>

            <!-- Seção de Edição de Motivadores (inicialmente escondida) -->
            <div id="editMotivatorsSection" class="edit-section hidden">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Editar Opções de Motivadores</h3>
                <div id="currentMotivatorOptions" class="mb-4">
                    <!-- Opções atuais para edição -->
                </div>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="newMotivatorInput" class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Adicionar nova opção">
                    <button id="addMotivatorBtn" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md transition duration-200">
                        Adicionar
                    </button>
                </div>
                <button id="saveMotivatorsBtn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Salvar Edições
                </button>
            </div>

            <!-- 5. Comente seu apontamento (opcional): -->
            <div class="mb-8 text-left">
                <label for="comments" class="block text-gray-700 text-lg font-medium mb-2">5. Comente seu apontamento (opcional):</label>
                <textarea id="comments" rows="5" class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" placeholder="Seu comentário aqui..."></textarea>
            </div>

            <button id="submitDetailSurveyBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-yellow-300">
                <span class="mr-2">✉️</span> Concluir Pesquisa
            </button>
        </div>

        <!-- Página de Login do Admin (inicialmente escondida) -->
        <div id="adminLoginPage" style="display: none;">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Acesso Administrativo</h1>
            <p class="text-gray-600 mb-8">Por favor, insira a senha para acessar o painel.</p>
            <input type="password" id="adminPasswordInput" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" placeholder="Senha">
            <button id="adminLoginBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                Entrar
            </button>
            <button id="backToInitialFromAdminLogin" class="w-full mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-gray-300">
                Voltar
            </button>
        </div>

        <!-- Painel Admin (inicialmente escondido) -->
        <div id="adminDashboardPage" style="display: none;">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Feedbacks e NPS</h1>
            <p class="text-gray-600 mb-8">Acompanhe a satisfação dos seus pacientes.</p>

            <!-- Net Promoter Score (NPS) Section for Admin -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Net Promoter Score (NPS)</h2>
                    <select id="npsPeriodSelect" class="p-2 border border-gray-300 rounded-md">
                        <option value="all">Todo o período</option>
                        <option value="7days">Últimos 7 dias</option>
                        <option value="30days">Últimos 30 dias</option>
                    </select>
                </div>

                <div class="nps-gauge-container">
                    <div class="nps-gauge">
                        <div id="adminNpsPointer" class="nps-pointer">0</div>
                    </div>
                    <div id="adminNpsScoreDisplay" class="nps-score-display">0</div>
                    <div class="nps-meta">Meta: 90</div>
                </div>
            </div>

            <!-- Novos Gráficos -->
            <div class="chart-container">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Distribuição de Avaliações Iniciais</h3>
                <div id="initialRatingChart"></div>
            </div>

            <div class="chart-container">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Distribuição por Ponto Motivador</h3>
                <div id="motivatorChart"></div>
            </div>

            <div class="chart-container">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Distribuição por Faixa Etária</h3>
                <div id="ageRangeChart"></div>
            </div>

            <!-- Base de Feedbacks Section for Admin -->
            <div>
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Base de Feedbacks</h2>
                <p class="text-gray-600 mb-4">Todos os feedbacks recebidos no período selecionado.</p>

                <div class="overflow-x-auto">
                    <table class="admin-data-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>ID do Usuário</th>
                                <th>Avaliação Inicial</th>
                                <th>Resolvido?</th>
                                <th>Tipo</th>
                                <th>Nota NPS</th>
                                <th>Motivador</th>
                                <th>Comentário</th>
                                <th>Faixa Etária</th>
                            </tr>
                        </thead>
                        <tbody id="surveyResultsBody">
                            <!-- Dados da pesquisa serão carregados aqui -->
                            <tr><td colspan="9" class="text-center text-gray-500">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <button id="backToInitialFromAdminDashboard" class="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-gray-300">
                Voltar
            </button>
        </div>
    </div>

    <!-- Container para botões de ação flutuantes -->
    <div class="floating-action-buttons-container">
        <a id="whatsappBtn" href="https://wa.me/5581999513952" target="_blank" class="floating-button whatsapp">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                <path d="M12.04 2c-6.63 0-12 5.4-12 12 0 2.22.6 4.33 1.7 6.2l-1.6 5.8 6.1-1.6c1.88.98 3.96 1.5 6.1 1.5 6.63 0 12-5.4 12-12s-5.37-12-12-12zm0 2.8c5.02 0 9.1 4.08 9.1 9.1s-4.08 9.1-9.1 9.1c-1.63 0-3.15-.42-4.48-1.16l-.32-.18-3.4 1.1 1.1-3.35-.2-.33c-.76-1.3-1.16-2.8-1.16-4.48 0-5.02 4.08-9.1 9.1-9.1zm4.8 11.8c-.18.12-.4.2-.6.28-.2.08-.4.12-.6.12-.2 0-.4-.04-.6-.12-.2-.08-.4-.16-.6-.28-.18-.12-.32-.28-.42-.48-.1-.2-.16-.4-.16-.6s.06-.4.16-.6c.1-.2.24-.36.42-.48.18-.12.4-.2.6-.28.2-.08.4-.12.6-.12.2 0 .4.04.6.12.2.08.4.16.6.28.18.12.32.28.42.48.1.2.16.4.16.6s-.06.4-.16.6c-.1.2-.24.36-.42.48zM8.5 7.7c-.18-.12-.4-.2-.6-.28-.2-.08-.4-.12-.6-.12-.2 0-.4.04-.6.12-.2.08-.4.16-.6.28-.18.12-.32.28-.42-.48-.1-.2-.16-.4-.16-.6s.06-.4.16-.6c.1-.2.24-.36.42-.48.18-.12.4-.2.6-.28.2-.08.4-.12.6-.12.2 0 .4.04.6.12.2.08.4.16.6.28.18.12.32.28.42.48.1.2.16.4.16.6s-.06.4-.16.6c-.1.2-.24.36-.42.48zM12.04 4.8c-2.48 0-4.5 2.02-4.5 4.5s2.02 4.5 4.5 4.5 4.5-2.02 4.5-4.5-2.02-4.5-4.5-4.5zm0 1.8c1.48 0 2.7 1.22 2.7 2.7s-1.22 2.7-2.7 2.7-2.7-1.22-2.7-2.7 1.22-2.7 2.7-2.7z"/>
            </svg>
        </a>
        <button id="goToAdminBtnFloating" class="floating-button admin">
            ⚙️
        </button>
    </div>

    <!-- Message Box for confirmation/error -->
    <div id="messageBox" class="message-box">
        <!-- O conteúdo da mensagem será definido pelo JavaScript -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Firebase instances from global window object
            const app = window.firebaseApp;
            const db = window.firebaseDb;
            const auth = window.firebaseAuth;
            const initialAuthToken = window.firebaseInitialAuthToken;
            const appId = window.firebaseAppId;
            const signInAnonymously = window.signInAnonymously;
            const onAuthStateChanged = window.onAuthStateChanged;
            const addDoc = window.addDoc;
            const collection = window.collection;
            const onSnapshot = window.onSnapshot;
            const query = window.query;
            const where = window.where;
            const signInWithCustomToken = window.signInWithCustomToken;

            // UI Elements
            const initialPage = document.getElementById('initialPage');
            const detailSurveyPage = document.getElementById('detailSurveyPage'); // Nova página de detalhes
            const adminLoginPage = document.getElementById('adminLoginPage');
            const adminDashboardPage = document.getElementById('adminDashboardPage');

            const emojiOptions = document.querySelectorAll('.emoji-option');
            const goToAdminBtnFloating = document.getElementById('goToAdminBtnFloating');
            const submitDetailSurveyBtn = document.getElementById('submitDetailSurveyBtn'); // Botão de envio da página de detalhes
            const commentsTextArea = document.getElementById('comments');
            const messageBox = document.getElementById('messageBox');

            const editMotivatorsBtn = document.getElementById('editMotivatorsBtn');
            const editMotivatorsSection = document.getElementById('editMotivatorsSection');
            const newMotivatorInput = document.getElementById('newMotivatorInput');
            const addMotivatorBtn = document.getElementById('addMotivatorBtn');
            const saveMotivatorsBtn = document.getElementById('saveMotivatorsBtn');
            const currentMotivatorOptionsDiv = document.getElementById('currentMotivatorOptions');
            const motivatorOptionsContainer = document.getElementById('motivatorOptionsContainer');

            const adminPasswordInput = document.getElementById('adminPasswordInput');
            const adminLoginBtn = document.getElementById('adminLoginBtn');
            const surveyResultsBody = document.getElementById('surveyResultsBody');
            const adminNpsPointer = document.getElementById('adminNpsPointer');
            const adminNpsScoreDisplay = document.getElementById('adminNpsScoreDisplay');
            const npsPeriodSelect = document.getElementById('npsPeriodSelect');
            const backToInitialFromAdminLogin = document.getElementById('backToInitialFromAdminLogin');
            const backToInitialFromAdminDashboard = document.getElementById('backToInitialFromAdminDashboard');

            // Chart containers
            const initialRatingChartContainer = document.getElementById('initialRatingChart');
            const motivatorChartContainer = document.getElementById('motivatorChart');
            const ageRangeChartContainer = document.getElementById('ageRangeChart');


            // State variables
            let selectedInitialRating = null;
            let selectedNPSScore = null; // NPS Score will be derived from initial rating for storage
            let motivatorOptions = JSON.parse(localStorage.getItem('motivatorOptions')) || ["Atendimento", "Comunicação", "Cumprimento de prazos", "Transparência"];
            let currentUserId = null;
            let isAuthReady = false;

            // --- Firebase Authentication ---
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log("Usuário autenticado:", currentUserId);
                } else {
                    console.log("Nenhum usuário autenticado.");
                    currentUserId = crypto.randomUUID(); // Fallback for unauthenticated
                }
                isAuthReady = true;
            });

            // --- Utility Functions ---
            function showMessage(message, isError = false) {
                messageBox.textContent = message;
                messageBox.classList.remove('bg-green-500', 'bg-red-500');
                if (isError) {
                    messageBox.classList.add('bg-red-500');
                } else {
                    messageBox.classList.add('bg-green-500');
                }
                messageBox.style.display = 'block';
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 3000);
            }

            // Function to reset all pages to hidden and show the initial page
            function resetToInitialPage() {
                initialPage.style.display = 'block';
                detailSurveyPage.style.display = 'none';
                adminLoginPage.style.display = 'none';
                adminDashboardPage.style.display = 'none';
                emojiOptions.forEach(opt => opt.classList.remove('selected')); // Clear selected emoji
                selectedInitialRating = null; // Reset selected initial rating
            }

            function renderMotivatorOptions() {
                motivatorOptionsContainer.innerHTML = '';
                motivatorOptions.forEach(option => {
                    const label = document.createElement('label');
                    label.className = 'radio-option';
                    label.innerHTML = `
                        <input type="radio" name="pontoMotivador" value="${option}" class="form-radio">
                        ${option}
                    `;
                    motivatorOptionsContainer.appendChild(label);
                });
            }

            function renderEditMotivatorOptions() {
                currentMotivatorOptionsDiv.innerHTML = '';
                if (motivatorOptions.length === 0) {
                    currentMotivatorOptionsDiv.innerHTML = '<p class="text-gray-500">Nenhuma opção adicionada ainda.</p>';
                    return;
                }
                motivatorOptions.forEach((option, index) => {
                    const div = document.createElement('div');
                    div.className = 'edit-option-item';
                    div.innerHTML = `
                        <span>${option}</span>
                        <button data-index="${index}" class="remove-motivator-btn bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded-md transition duration-200">Remover</button>
                    `;
                    currentMotivatorOptionsDiv.appendChild(div);
                });

                document.querySelectorAll('.remove-motivator-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const index = parseInt(event.target.dataset.index);
                        motivatorOptions.splice(index, 1);
                        renderEditMotivatorOptions();
                        renderMotivatorOptions();
                        localStorage.setItem('motivatorOptions', JSON.stringify(motivatorOptions));
                    });
                });
            }

            function updateNPSGauge(score) {
                score = Math.max(-100, Math.min(100, score));
                const position = ((score + 100) / 200) * 100;

                adminNpsPointer.style.left = `${position}%`;
                adminNpsPointer.textContent = score;
                adminNpsScoreDisplay.textContent = score;
            }

            // Função para renderizar gráficos de barra
            function renderBarChart(container, data, title) {
                container.innerHTML = ''; // Limpa o gráfico existente
                const total = Object.values(data).reduce((sum, count) => sum + count, 0);

                if (total === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center">Nenhum dado para ${title}.</p>`;
                    return;
                }

                for (const label in data) {
                    const count = data[label];
                    const percentage = total > 0 ? (count / total) * 100 : 0;

                    const item = document.createElement('div');
                    item.className = 'chart-bar-item';
                    item.innerHTML = `
                        <span class="chart-bar-label">${label}</span>
                        <div class="chart-bar-bg">
                            <div class="chart-bar-fill" style="width: ${percentage.toFixed(1)}%;"></div>
                        </div>
                        <span class="chart-bar-value">${count} (${percentage.toFixed(1)}%)</span>
                    `;
                    container.appendChild(item);
                }
            }


            function loadSurveyData(period = 'all') {
                if (!isAuthReady) {
                    console.log("Autenticação não pronta, tentando novamente em breve...");
                    setTimeout(() => loadSurveyData(period), 500);
                    return;
                }

                surveyResultsBody.innerHTML = '<tr><td colspan="9" class="text-center text-gray-500">Carregando dados...</td></tr>';
                try {
                    let q = collection(db, `/artifacts/${appId}/public/data/surveyResponses`);

                    if (period === '7days') {
                        const sevenDaysAgo = new Date();
                        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                        q = query(q, where('timestamp', '>=', sevenDaysAgo));
                    } else if (period === '30days') {
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        q = query(q, where('timestamp', '>=', thirtyDaysAgo));
                    }

                    onSnapshot(q, (snapshot) => {
                        surveyResultsBody.innerHTML = '';
                        const feedbacks = [];
                        let promoters = 0;
                        let detractors = 0;
                        let totalResponses = 0;

                        const initialRatingCounts = {};
                        const motivatorCounts = {};
                        const ageRangeCounts = {};

                        if (snapshot.empty) {
                            surveyResultsBody.innerHTML = '<tr><td colspan="9" class="text-center text-gray-500">Nenhum dado de pesquisa encontrado.</td></tr>';
                            updateNPSGauge(0);
                            renderBarChart(initialRatingChartContainer, {}, 'Avaliações Iniciais');
                            renderBarChart(motivatorChartContainer, {}, 'Pontos Motivadores');
                            renderBarChart(ageRangeChartContainer, {}, 'Faixas Etárias');
                            return;
                        }

                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            feedbacks.push({
                                id: doc.id,
                                date: data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'N/A',
                                userId: data.userId || 'N/A',
                                initialRating: data.initialRating || 'N/A',
                                resolved: data.necessidadeResolvida || 'N/A',
                                type: data.tipoRetorno || 'N/A',
                                npsScore: data.npsScore !== undefined ? data.npsScore : 'N/A',
                                motivator: data.pontoMotivador || 'N/A',
                                comment: data.comments || 'N/A',
                                ageRange: data.ageRange || 'N/A'
                            });

                            // Populate data for charts
                            if (data.initialRating) {
                                initialRatingCounts[data.initialRating] = (initialRatingCounts[data.initialRating] || 0) + 1;
                            }
                            if (data.pontoMotivador) {
                                motivatorCounts[data.pontoMotivador] = (motivatorCounts[data.pontoMotivador] || 0) + 1;
                            }
                            if (data.ageRange) {
                                ageRangeCounts[data.ageRange] = (ageRangeCounts[data.ageRange] || 0) + 1;
                            }

                            // Calculate NPS (using the 0-10 scale from the detailed survey if present, or deriving from initial rating)
                            // For this project, NPS is calculated from the initial emoji rating mapping
                            let npsScoreFromEmoji = 0;
                            switch(data.initialRating) {
                                case 'Excelente': npsScoreFromEmoji = 10; break;
                                case 'Bom': npsScoreFromEmoji = 8; break;
                                case 'Regular': npsScoreFromEmoji = 6; break;
                                case 'Ruim': npsScoreFromEmoji = 3; break;
                                case 'Péssimo': npsScoreFromEmoji = 0; break;
                                default: npsScoreFromEmoji = 0; // Default or handle N/A
                            }

                            if (npsScoreFromEmoji >= 9) {
                                promoters++;
                            } else if (npsScoreFromEmoji <= 6) {
                                detractors++;
                            }
                            totalResponses++;
                        });

                        // Populate the table
                        feedbacks.forEach(feedback => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${feedback.date}</td>
                                <td>${feedback.userId}</td>
                                <td>${feedback.initialRating}</td>
                                <td>${feedback.resolved}</td>
                                <td>${feedback.type}</td>
                                <td>${feedback.npsScore}</td>
                                <td>${feedback.motivator}</td>
                                <td>${feedback.comment}</td>
                                <td>${feedback.ageRange}</td>
                            `;
                            surveyResultsBody.appendChild(row);
                        });

                        // Update NPS Gauge
                        if (totalResponses > 0) {
                            const nps = ((promoters - detractors) / totalResponses) * 100;
                            updateNPSGauge(Math.round(nps));
                        } else {
                            updateNPSGauge(0);
                        }

                        // Render charts
                        renderBarChart(initialRatingChartContainer, initialRatingCounts, 'Avaliações Iniciais');
                        renderBarChart(motivatorChartContainer, motivatorCounts, 'Pontos Motivadores');
                        renderBarChart(ageRangeChartContainer, ageRangeCounts, 'Faixas Etárias');

                    }, (error) => {
                        console.error("Erro ao carregar dados do Firestore:", error);
                        surveyResultsBody.innerHTML = '<tr><td colspan="9" class="text-center text-red-500">Erro ao carregar dados.</td></tr>';
                        showMessage('Erro ao carregar dados do painel de administração.', true);
                    });
                } catch (error) {
                    console.error("Erro ao configurar listener do Firestore:", error);
                    surveyResultsBody.innerHTML = '<tr><td colspan="9" class="text-center text-red-500">Erro ao iniciar o carregamento de dados.</td></tr>';
                    showMessage('Erro ao iniciar o carregamento de dados do painel de administração.', true);
                }
            }


            // --- Initial Setup ---
            resetToInitialPage(); // Call this function on page load to ensure initial state
            renderMotivatorOptions();

            // --- Event Listeners ---
            emojiOptions.forEach(option => {
                option.addEventListener('click', () => {
                    emojiOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedInitialRating = option.dataset.value;

                    // Navega diretamente para a página de detalhes da pesquisa
                    initialPage.style.display = 'none';
                    detailSurveyPage.style.display = 'block';
                    console.log('Avaliação inicial selecionada:', selectedInitialRating);
                });
            });

            // Adiciona listener de clique ao botão flutuante 'Acessar Painel Admin'
            goToAdminBtnFloating.addEventListener('click', () => {
                initialPage.style.display = 'none';
                detailSurveyPage.style.display = 'none';
                adminLoginPage.style.display = 'block';
                adminPasswordInput.value = '';
            });

            backToInitialFromAdminLogin.addEventListener('click', () => {
                adminLoginPage.style.display = 'none';
                initialPage.style.display = 'block';
            });

            backToInitialFromAdminDashboard.addEventListener('click', () => {
                adminDashboardPage.style.display = 'none';
                initialPage.style.display = 'block';
            });

            // Lógica para o botão "Editar Opções"
            editMotivatorsBtn.addEventListener('click', () => {
                editMotivatorsSection.classList.toggle('hidden');
                renderEditMotivatorOptions();
            });

            // Lógica para adicionar nova opção de motivador
            addMotivatorBtn.addEventListener('click', () => {
                const newValue = newMotivatorInput.value.trim();
                if (newValue && !motivatorOptions.includes(newValue)) {
                    motivatorOptions.push(newValue);
                    newMotivatorInput.value = '';
                    renderEditMotivatorOptions();
                    renderMotivatorOptions();
                    localStorage.setItem('motivatorOptions', JSON.stringify(motivatorOptions));
                } else if (newValue && motivatorOptions.includes(newValue)) {
                    showMessage('Esta opção já existe.', true);
                } else {
                    showMessage('Por favor, digite uma opção válida.', true);
                }
            });

            // Lógica para salvar edições (esconde a seção de edição)
            saveMotivatorsBtn.addEventListener('click', () => {
                editMotivatorsSection.classList.add('hidden');
                showMessage('Opções de motivadores salvas!', false);
            });

            // Adiciona listener de clique ao botão 'Concluir Pesquisa' (da página de detalhes)
            submitDetailSurveyBtn.addEventListener('click', async () => {
                const necessidadeResolvida = document.querySelector('input[name="necessidadeResolvida"]:checked')?.value;
                const tipoRetorno = document.querySelector('input[name="tipoRetorno"]:checked')?.value;
                const pontoMotivador = document.querySelector('input[name="pontoMotivador"]:checked')?.value;
                const ageRange = document.querySelector('input[name="ageRange"]:checked')?.value; // Captura a faixa etária
                const comments = commentsTextArea.value.trim();

                if (!necessidadeResolvida || !tipoRetorno || !pontoMotivador || !ageRange) { // Valida a faixa etária
                    showMessage('Por favor, preencha todos os campos obrigatórios antes de enviar.', true);
                    return;
                }

                // Mapeia a avaliação inicial (carinha) para um NPS Score de 0-10 para armazenamento
                let npsScoreDerived = 0;
                switch(selectedInitialRating) {
                    case 'Excelente': npsScoreDerived = 10; break;
                    case 'Bom': npsScoreDerived = 8; break;
                    case 'Regular': npsScoreDerived = 6; break;
                    case 'Ruim': npsScoreDerived = 3; break;
                    case 'Péssimo': npsScoreDerived = 0; break;
                    default: npsScoreDerived = 0;
                }

                const surveyData = {
                    userId: currentUserId,
                    initialRating: selectedInitialRating,
                    necessidadeResolvida: necessidadeResolvida,
                    tipoRetorno: tipoRetorno,
                    npsScore: npsScoreDerived, // Usa o NPS derivado da carinha
                    pontoMotivador: pontoMotivador,
                    comments: comments,
                    ageRange: ageRange, // Salva a faixa etária
                    timestamp: new Date()
                };

                try {
                    if (isAuthReady) {
                        await addDoc(collection(db, `/artifacts/${appId}/public/data/surveyResponses`), surveyData);
                        console.log('Dados da Pesquisa salvos no Firestore:', surveyData);
                        showMessage('Avaliação enviada com sucesso!');
                    } else {
                        showMessage('Erro: Autenticação não pronta. Tente novamente.', true);
                        console.error('Erro: Autenticação Firebase não pronta.');
                        return;
                    }
                } catch (e) {
                    console.error("Erro ao adicionar documento: ", e);
                    showMessage('Erro ao enviar avaliação. Tente novamente.', true);
                    return;
                }

                // Reseta o formulário
                document.querySelectorAll('input[name="necessidadeResolvida"]').forEach(radio => radio.checked = false);
                document.querySelectorAll('input[name="tipoRetorno"]').forEach(radio => radio.checked = false);
                document.querySelectorAll('input[name="pontoMotivador"]').forEach(radio => radio.checked = false);
                document.querySelectorAll('input[name="ageRange"]').forEach(radio => radio.checked = false); // Reseta faixa etária
                commentsTextArea.value = '';
                selectedInitialRating = null;

                // Volta para a página inicial após o envio
                setTimeout(() => {
                    resetToInitialPage(); // Use a função de reset
                }, 3000);
            });

            // Lógica de login do Admin
            adminLoginBtn.addEventListener('click', () => {
                const password = adminPasswordInput.value;
                const correctPassword = "123";

                if (password === correctPassword) {
                    adminLoginPage.style.display = 'none';
                    adminDashboardPage.style.display = 'block';
                    loadSurveyData(npsPeriodSelect.value);
                } else {
                    showMessage('Senha incorreta. Tente novamente.', true);
                    adminPasswordInput.value = '';
                }
            });

            // Listener para o filtro de período no painel admin
            npsPeriodSelect.addEventListener('change', (event) => {
                loadSurveyData(event.target.value);
            });
        });
    </script>
</body>
</html>