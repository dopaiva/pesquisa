<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesquisa de Satisfa√ß√£o para Treinamento/Palestra</title>
    <!-- Incluindo Tailwind CSS para estiliza√ß√£o -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase (will be populated by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Export Firebase instances and functions to be accessible in the main script
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.firebaseInitialAuthToken = initialAuthToken;
        window.firebaseAppId = appId;
        window.signInAnonymously = signInAnonymously;
        window.onAuthStateChanged = onAuthStateChanged;
        window.addDoc = addDoc;
        window.collection = collection;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.where = where;
        window.signInWithCustomToken = signInWithCustomToken;
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background for a modern feel */
            display: flex;
            justify-content: center;
            align-items: center; /* Center vertically for initial view */
            min-height: 100vh;
            padding: 2rem;
            overflow-x: hidden; /* Prevent horizontal scroll */
            box-sizing: border-box; /* Include padding in element's total width and height */
        }
        .container {
            background-color: #ffffff;
            padding: 3rem; /* Increased padding */
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1); /* Stronger shadow for depth */
            max-width: 900px;
            width: 100%;
            text-align: center;
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 2rem; /* Space between sections */
        }

        /* Message Box Styling */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #22c55e; /* Green for success */
            color: white;
            padding: 1.5rem 2.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            display: none;
            font-weight: 700; /* Bolder text */
            font-size: 1.125rem; /* Slightly larger font */
            animation: fadeInOut 3s forwards; /* Animation for messages */
        }
        .error-message-box {
            background-color: #ef4444; /* Red for error */
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            10% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            90% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        }

        /* NPS Score Options Styling (0-10 scale) */
        .nps-scale {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem; /* Increased gap */
            margin-top: 1.5rem;
        }
        .nps-score-option {
            width: 4rem; /* Larger for better tap target */
            height: 4rem; /* Larger for better tap target */
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #e0e0e0; /* Softer border */
            border-radius: 0.75rem; /* Slightly more rounded */
            cursor: pointer;
            transition: all 0.3s ease-in-out; /* Smoother transition */
            font-weight: 700;
            font-size: 1.8rem; /* Larger font for numbers */
            color: #555; /* Softer text color */
            background-color: #fcfcfc; /* Slightly off-white background */
        }
        .nps-score-option:hover {
            transform: translateY(-5px); /* More pronounced lift effect */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15); /* Stronger shadow on hover */
            border-color: #a0a0a0; /* Darker border on hover */
        }
        .nps-score-option.selected {
            background-color: #3b82f6; /* Blue selected color */
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 0 0 5px rgba(59, 130, 246, 0.4); /* More prominent glow */
            transform: scale(1.1); /* Slight enlarge on select */
        }

        /* New NPS Color Classes */
        .nps-score-option.nps-detractor {
            background-color: #ef4444; /* Red for 0-6 */
            color: white;
            border-color: #ef4444;
        }
        .nps-score-option.nps-neutral {
            background-color: #facc15; /* Yellow for 7-8 */
            color: #333; /* Darker text for contrast */
            border-color: #facc15;
        }
        .nps-score-option.nps-promoter {
            background-color: #22c55e; /* Green for 9-10 */
            color: white;
            border-color: #22c55e;
        }

        /* Media queries for NPS score options responsiveness */
        @media (max-width: 640px) { /* Tailwind's 'sm' breakpoint */
            .nps-score-option {
                width: 16vw; /* More fluid relative to viewport width */
                height: 16vw;
                font-size: 1.5rem; /* Smaller font on small screens */
                border-radius: 0.6rem;
            }
            .nps-scale {
                gap: 0.5rem; /* Reduce gap on smaller screens */
            }
        }
        @media (max-width: 480px) { /* Even smaller screens */
            .nps-score-option {
                width: 18vw; /* Even smaller */
                height: 18vw;
                font-size: 1.3rem;
                border-radius: 0.5rem; /* Slightly less rounded */
            }
            .nps-scale {
                gap: 0.4rem; /* Further reduce gap */
            }
        }


        /* Consent Page Buttons */
        .consent-options {
            display: flex;
            justify-content: center;
            gap: 2rem; /* Increased gap */
            margin-top: 2.5rem;
        }
        .consent-button {
            padding: 1.2rem 3rem; /* Larger padding */
            font-size: 1.25rem; /* Larger font */
            font-weight: 700;
            border-radius: 1rem; /* More rounded */
            transition: all 0.3s ease-in-out;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .consent-button.yes {
            background-color: #28a745; /* Darker green */
            color: white;
        }
        .consent-button.yes:hover {
            background-color: #218838;
            transform: translateY(-3px) scale(1.02);
        }
        .consent-button.no {
            background-color: #dc3545; /* Darker red */
            color: white;
        }
        .consent-button.no:hover {
            background-color: #c82333;
            transform: translateY(-3px) scale(1.02);
        }

        /* Floating Elements Styling (Enhanced) */
        .floating-element {
            position: absolute;
            opacity: 0.6; /* Increased opacity for better visibility */
            font-size: 5rem; /* Larger size */
            animation: float 15s ease-in-out infinite; /* Slower, smoother animation */
            filter: blur(1px); /* Slightly less blur */
            user-select: none; /* Prevent selection */
            pointer-events: none; /* Do not interfere with clicks */
        }
        .floating-element:nth-child(1) { top: 15%; left: 8%; animation-delay: 0s; transform: rotate(10deg); color: #FFD700; } /* Gold star */
        .floating-element:nth-child(2) { top: 75%; left: 85%; animation-delay: 3s; animation-duration: 18s; transform: rotate(-15deg); color: #4B0082; } /* Indigo brain */
        .floating-element:nth-child(3) { top: 25%; left: 92%; animation-delay: 6s; animation-duration: 12s; transform: rotate(20deg); color: #00BFFF; } /* Deep sky blue trophy */
        .floating-element:nth-child(4) { top: 88%; left: 12%; animation-delay: 9s; animation-duration: 16s; transform: rotate(-5deg); color: #32CD32; } /* Lime green thumbs up */
        .floating-element:nth-child(5) { top: 45%; left: 48%; animation-delay: 1.5s; animation-duration: 14s; transform: rotate(25deg); color: #8A2BE2; } /* Blue violet graduation cap */


        @keyframes float {
            0% { transform: translate(0, 0) rotate(var(--initial-rotation, 0deg)); }
            25% { transform: translate(15px, 25px) rotate(calc(var(--initial-rotation, 0deg) + 8deg)); }
            50% { transform: translate(-15px, 0px) rotate(calc(var(--initial-rotation, 0deg) - 8deg)); }
            75% { transform: translate(8px, -20px) rotate(calc(var(--initial-rotation, 0deg) + 4deg)); }
            100% { transform: translate(0, 0) rotate(var(--initial-rotation, 0deg)); }
        }

        /* General Input and Button Styling */
        input[type="text"], input[type="password"], textarea {
            border-radius: 0.75rem; /* More rounded */
            padding: 0.75rem 1.25rem; /* More padding */
            border: 1px solid #d1d5db;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        input[type="text"]:focus, input[type="password"]:focus, textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            outline: none;
        }
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem; /* Consistent gap */
            justify-content: flex-start; /* Align left */
        }
        .radio-option {
            background-color: #f9fafb;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease-in-out;
        }
        .radio-option:hover {
            background-color: #edf2f7;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }
        .radio-option input[type="radio"] {
            accent-color: #3b82f6; /* Blue radio button */
            margin-right: 0.5rem;
        }

        /* Submit Button Styling */
        .submit-button {
            background-color: #10b981; /* Green for submit */
            color: white;
            font-weight: 700;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .submit-button:hover {
            background-color: #059669;
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        /* Admin Dashboard Styling */
        #adminDashboardPage {
            display: flex; /* Use flexbox for layout */
            flex-direction: column; /* Stack children vertically */
            gap: 2.5rem; /* Increased gap between sections for better visual separation */
            padding: 2rem; /* Add padding to the whole dashboard page */
        }

        .admin-data-table {
            width: 100%;
            border-collapse: collapse; /* Changed to collapse for better consistency */
            margin-top: 1.5rem;
            border-radius: 0.75rem; /* Rounded corners for the table itself */
            overflow: hidden; /* Ensures rounded corners are visible */
        }
        .admin-data-table th, .admin-data-table td {
            border: 1px solid #e5e7eb;
            padding: 1rem; /* Increased padding for better readability */
            text-align: left;
            font-size: 0.95rem; /* Slightly larger font */
        }
        .admin-data-table th {
            background-color: #e2e8f0; /* Lighter header for table */
            color: #333;
            font-weight: 700;
        }
        .admin-data-table tbody tr:hover {
            background-color: #f0f4f8; /* Hover effect for table rows */
        }
        /* No need for specific rounded corner styles for cells when border-collapse is collapse */


        /* Chart Bar Styling */
        .chart-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background-color: #f9fafb;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            text-align: left;
        }
        .chart-bar-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .chart-bar-label {
            width: 120px;
            font-size: 0.875rem;
            color: #4b5563;
            flex-shrink: 0;
        }
        .chart-bar-bg {
            flex-grow: 1;
            height: 20px;
            background-color: #e5e7eb;
            border-radius: 0.25rem;
            overflow: hidden;
        }
        .chart-bar-fill {
            height: 100%;
            background-color: #4c51bf; /* Deeper blue for charts */
            border-radius: 0.25rem;
            transition: width 0.5s ease-out;
        }
        .chart-bar-value {
            margin-left: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #1f2937;
        }

        /* Adjustments for NPS Gauge */
        .nps-gauge-container {
            padding: 1.5rem; /* Add padding to gauge container */
            background-color: #f9fafb;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            margin-bottom: 2rem; /* Add space below the gauge */
        }
        .nps-score-display {
            font-size: 3.5rem; /* Larger NPS score display */
            margin-top: 1rem;
        }

        /* Floating action buttons container */
        .floating-action-buttons-container {
            position: fixed; /* Fixed position relative to the viewport */
            bottom: 1.5rem; /* 1.5rem from the bottom */
            right: 1.5rem; /* 1.5rem from the right */
            display: flex;
            flex-direction: column;
            gap: 1rem; /* Space between buttons */
            z-index: 100; /* Ensure it's on top of most content */
        }

        .floating-button {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 3.5rem; /* Fixed width for a circle */
            height: 3.5rem; /* Fixed height for a circle */
            border-radius: 50%; /* Make it round */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Soft shadow */
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            text-decoration: none; /* Remove underline for links */
            color: white; /* Default text color */
            font-size: 1.5rem; /* Adjust icon size */
        }

        .floating-button.whatsapp {
            background-color: #25d366; /* WhatsApp green */
        }

        .floating-button.whatsapp:hover {
            background-color: #1da851; /* Darker green on hover */
            transform: scale(1.1);
        }

        .floating-button.admin {
            background-color: #6b7280; /* Gray for settings/admin */
        }

        .floating-button.admin:hover {
            background-color: #4b5563; /* Darker gray on hover */
            transform: scale(1.1);
        }

        .floating-button svg {
            fill: currentColor; /* Use button's text color for SVG fill */
            width: 1.5rem;
            height: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- Floating elements (generic icons to enhance visual appeal) -->
    <div class="floating-element" style="--initial-rotation: 10deg;">‚≠ê</div>
    <div class="floating-element" style="--initial-rotation: -15deg;">üß†</div>
    <div class="floating-element" style="--initial-rotation: 20deg;">üèÜ</div>
    <div class="floating-element" style="--initial-rotation: -5deg;">üëç</div>
    <div class="floating-element" style="--initial-rotation: 25deg;">üéì</div>

    <div class="container">
        <!-- Initial Page (0-10 Rating) -->
        <div id="initialPage">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-4">Avalie sua Experi√™ncia!</h1>
            <p class="text-lg text-gray-600 mb-10">De 0 a 10, qual a probabilidade de voc√™ recomendar este treinamento/palestra a um colega?</p>

            <div id="npsScaleContainer" class="nps-scale">
                <!-- Numbers from 0 to 10 will be generated here by JavaScript -->
            </div>
        </div>

        <!-- Consent Page for More Collaboration (initially hidden) -->
        <div id="consentPage" style="display: none;">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-4">Gostaria de Colaborar Mais?</h1>
            <p class="text-lg text-gray-600 mb-10">Sua opini√£o detalhada nos ajuda a aprimorar nossos conte√∫dos.</p>
            <div class="consent-options">
                <button id="consentYesBtn" class="consent-button yes">Sim</button>
                <button id="consentNoBtn" class="consent-button no">N√£o</button>
            </div>
        </div>

        <!-- Survey Details Page (initially hidden) -->
        <div id="detailSurveyPage" style="display: none;">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-4">Detalhes da Sua Percep√ß√£o</h1>
            <p class="text-lg text-gray-600 mb-10">Conte-nos mais para nos ajudar a melhorar o treinamento/palestra.</p>

            <!-- 1. O conte√∫do abordou suas expectativas? -->
            <div class="mb-6 text-left">
                <p class="text-gray-700 text-lg font-semibold mb-3">1. O conte√∫do abordou suas expectativas?</p>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="expectativasAtendidas" value="Sim" class="form-radio">
                        Sim
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="expectativasAtendidas" value="N√£o" class="form-radio">
                        N√£o
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="expectativasAtendidas" value="Parcialmente" class="form-radio">
                        Parcialmente
                    </label>
                </div>
            </div>

            <!-- 2. Sua percep√ß√£o geral sobre a palestra/treinamento √©: -->
            <div class="mb-6 text-left">
                <p class="text-gray-700 text-lg font-semibold mb-3">2. Sua percep√ß√£o geral sobre a palestra/treinamento √©:</p>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="percepcaoGeral" value="Muito Positiva" class="form-radio">
                        Muito Positiva
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="percepcaoGeral" value="Positiva" class="form-radio">
                        Positiva
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="percepcaoGeral" value="Neutra" class="form-radio">
                        Neutra
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="percepcaoGeral" value="Negativa" class="form-radio">
                        Negativa
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="percepcaoGeral" value="Muito Negativa" class="form-radio">
                        Muito Negativa
                    </label>
                </div>
            </div>

            <!-- 3. Qual a sua faixa et√°ria? -->
            <div class="mb-6 text-left">
                <p class="text-gray-700 text-lg font-semibold mb-3">3. Qual a sua faixa et√°ria?</p>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="ageRange" value="Menos de 18" class="form-radio">
                        Menos de 18
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="ageRange" value="18-24" class="form-radio">
                        18-24
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="ageRange" value="25-34" class="form-radio">
                        25-34
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="ageRange" value="35-44" class="form-radio">
                        35-44
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="ageRange" value="45-54" class="form-radio">
                        45-54
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="ageRange" value="55-64" class="form-radio">
                        55-64
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="ageRange" value="65 ou mais" class="form-radio">
                        65 ou mais
                    </label>
                </div>
            </div>

            <!-- 4. Sinalize o principal ponto motivador da sua resposta: -->
            <div class="mb-8 text-left">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-gray-700 text-lg font-semibold">4. Sinalize o principal ponto motivador da sua resposta:</p>
                    <button id="editMotivatorsBtn" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded-md transition duration-200">
                        Editar Op√ß√µes
                    </button>
                </div>
                <div id="motivatorOptionsContainer" class="radio-group">
                    <!-- Options will be loaded here via JavaScript -->
                </div>
            </div>

            <!-- Motivator Edit Section (initially hidden) -->
            <div id="editMotivatorsSection" class="edit-section hidden">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Editar Op√ß√µes de Motivadores</h3>
                <div id="currentMotivatorOptions" class="mb-4">
                    <!-- Current options for editing -->
                </div>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="newMotivatorInput" class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Adicionar nova op√ß√£o">
                    <button id="addMotivatorBtn" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md transition duration-200">
                        Adicionar
                    </button>
                </div>
                <button id="saveMotivatorsBtn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Salvar Edi√ß√µes
                </button>
            </div>

            <!-- 5. Comente seu apontamento (opcional): -->
            <div class="mb-8 text-left">
                <label for="comments" class="block text-gray-700 text-lg font-semibold mb-2">5. Comente seu apontamento (opcional):</label>
                <textarea id="comments" rows="5" class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" placeholder="Seu coment√°rio aqui..."></textarea>
            </div>

            <button id="submitDetailSurveyBtn" class="w-full submit-button">
                <span class="mr-2">‚úâÔ∏è</span> Concluir Pesquisa Detalhada
            </button>
        </div>

        <!-- Admin Login Page (maintained) -->
        <div id="adminLoginPage" style="display: none;">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-4">Acesso Administrativo</h1>
            <p class="text-lg text-gray-600 mb-10">Por favor, insira a senha para acessar o painel.</p>
            <input type="password" id="adminPasswordInput" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" placeholder="Senha">
            <button id="adminLoginBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                Entrar
            </button>
            <button id="backToInitialFromAdminLogin" class="w-full mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-gray-300">
                Voltar
            </button>
        </div>

        <!-- Admin Dashboard (maintained with adjustments for new data) -->
        <div id="adminDashboardPage" style="display: none;">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-4">Resultados da Pesquisa de Treinamento</h1>
            <p class="text-lg text-gray-600 mb-10">Acompanhe as avalia√ß√µes e feedbacks dos participantes.</p>

            <!-- Net Promoter Score (NPS) Section for Admin (adapted for the new scale) -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Net Promoter Score (NPS)</h2>
                    <select id="npsPeriodSelect" class="p-2 border border-gray-300 rounded-md">
                        <option value="all">Todo o per√≠odo</option>
                        <option value="7days">√öltimos 7 dias</option>
                        <option value="30days">√öltimos 30 dias</option>
                    </select>
                </div>

                <div class="nps-gauge-container">
                    <div class="nps-gauge">
                        <div id="adminNpsPointer" class="nps-pointer">0</div>
                    </div>
                    <div id="adminNpsScoreDisplay" class="nps-score-display">0</div>
                    <div class="nps-meta">Meta: 90</div>
                </div>
            </div>

            <!-- New Charts (adapted) -->
            <div class="chart-container">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Distribui√ß√£o de Notas (0-10)</h3>
                <div id="initialRatingChart"></div>
            </div>

            <div class="chart-container">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Distribui√ß√£o por Ponto Motivador</h3>
                <div id="motivatorChart"></div>
            </div>

            <div class="chart-container">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Distribui√ß√£o por Faixa Et√°ria</h3>
                <div id="ageRangeChart"></div>
            </div>

            <!-- Feedback Base Section for Admin (adapted) -->
            <div>
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Base de Feedbacks</h2>
                <p class="text-gray-600 mb-4">Todos os feedbacks recebidos no per√≠odo selecionado.</p>

                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table class="admin-data-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>ID Usu√°rio</th>
                                <th>Nota (0-10)</th>
                                <th>Expectativa Atendida?</th>
                                <th>Percep√ß√£o Geral</th>
                                <th>Motivador</th>
                                <th>Coment√°rio</th>
                                <th>Faixa Et√°ria</th>
                            </tr>
                        </thead>
                        <tbody id="surveyResultsBody">
                            <!-- Survey data will be loaded here -->
                            <tr><td colspan="8" class="text-center text-gray-500 py-4">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <button id="backToInitialFromAdminDashboard" class="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-gray-300">
                Voltar
            </button>
        </div>
    </div>

    <!-- Container for floating action buttons -->
    <div class="floating-action-buttons-container">
        <a id="whatsappBtn" href="https://wa.me/5581999513952" target="_blank" class="floating-button whatsapp">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                <path d="M12.04 2c-6.63 0-12 5.4-12 12 0 2.22.6 4.33 1.7 6.2l-1.6 5.8 6.1-1.6c1.88.98 3.96 1.5 6.1 1.5 6.63 0 12-5.4 12-12s-5.37-12-12-12zm0 2.8c5.02 0 9.1 4.08 9.1 9.1s-4.08 9.1-9.1 9.1c-1.63 0-3.15-.42-4.48-1.16l-.32-.18-3.4 1.1 1.1-3.35-.2-.33c-.76-1.3-1.16-2.8-1.16-4.48 0-5.02 4.08-9.1 9.1-9.1zm4.8 11.8c-.18.12-.4.2-.6.28-.2.08-.4.12-.6.12-.2 0-.4-.04-.6-.12-.2-.08-.4-.16-.6-.28-.18-.12-.32-.28-.42-.48-.1-.2-.16-.4-.16-.6s.06-.4.16-.6c.1-.2.24-.36.42-.48.18-.12.4-.2.6-.28.2-.08.4-.12.6-.12.2 0 .4.04.6.12.2.08.4.16.6.28.18.12.32.28.42.48.1.2.16.4.16.6s-.06.4-.16.6c-.1.2-.24.36-.42.48zM8.5 7.7c-.18-.12-.4-.2-.6-.28-.2-.08-.4-.12-.6-.12-.2 0-.4.04-.6.12-.2.08-.4.16-.6.28-.18.12-.32-.28-.42-.48-.1-.2-.16-.4-.16-.6s.06-.4.16-.6c.1-.2.24-.36.42-.48.18-.12.4-.2.6-.28.2-.08.4-.12.6-.12.2 0 .4.04.6.12.2.08.4.16.6.28.18.12.32.28.42.48.1.2.16.4.16.6s-.06.4-.16.6c-.1.2-.24.36-.42.48zM12.04 4.8c-2.48 0-4.5 2.02-4.5 4.5s2.02 4.5 4.5 4.5 4.5-2.02 4.5-4.5-2.02-4.5-4.5-4.5zm0 1.8c1.48 0 2.7 1.22 2.7 2.7s-1.22 2.7-2.7 2.7-2.7-1.22-2.7-2.7 1.22-2.7 2.7-2.7z"/>
            </svg>
        </a>
        <button id="goToAdminBtnFloating" class="floating-button admin">
            ‚öôÔ∏è
        </button>
    </div>

    <!-- Message Box for confirmation/error -->
    <div id="messageBox" class="message-box">
        <!-- Message content will be set by JavaScript -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM totalmente carregado. Iniciando script.");

            // Firebase instances from global window object
            const app = window.firebaseApp; 
            const db = window.firebaseDb;   
            const auth = window.firebaseAuth; 
            const initialAuthToken = window.firebaseInitialAuthToken; 
            const appId = window.firebaseAppId; 
            const signInAnonymously = window.signInAnonymously; 
            const onAuthStateChanged = window.onAuthStateChanged; 
            const addDoc = window.addDoc; 
            const collection = window.collection; 
            const onSnapshot = window.onSnapshot; 
            const query = window.query; 
            const where = window.where; 
            const signInWithCustomToken = window.signInWithCustomToken; 


            // UI Elements
            const initialPage = document.getElementById('initialPage');
            const consentPage = document.getElementById('consentPage'); 
            const detailSurveyPage = document.getElementById('detailSurveyPage'); 
            const adminLoginPage = document.getElementById('adminLoginPage');
            const adminDashboardPage = document.getElementById('adminDashboardPage');

            // Changed to let so it can be re-assigned after dynamic creation
            let npsScoreOptions; 
            const npsScaleContainer = document.getElementById('npsScaleContainer'); // New reference for the container

            const consentYesBtn = document.getElementById('consentYesBtn');
            const consentNoBtn = document.getElementById('consentNoBtn');
            const goToAdminBtnFloating = document.getElementById('goToAdminBtnFloating');
            const submitDetailSurveyBtn = document.getElementById('submitDetailSurveyBtn');
            const commentsTextArea = document.getElementById('comments');
            const messageBox = document.getElementById('messageBox');

            const editMotivatorsBtn = document.getElementById('editMotivatorsBtn');
            const editMotivatorsSection = document.getElementById('editMotivatorsSection');
            const newMotivatorInput = document.getElementById('newMotivatorInput');
            const addMotivatorBtn = document.getElementById('addMotivatorBtn');
            const saveMotivatorsBtn = document.getElementById('saveMotivatorsBtn');
            const currentMotivatorOptionsDiv = document.getElementById('currentMotivatorOptions');
            const motivatorOptionsContainer = document.getElementById('motivatorOptionsContainer');

            const adminPasswordInput = document.getElementById('adminPasswordInput');
            const adminLoginBtn = document.getElementById('adminLoginBtn');
            const surveyResultsBody = document.getElementById('surveyResultsBody');
            const adminNpsPointer = document.getElementById('adminNpsPointer');
            const adminNpsScoreDisplay = document.getElementById('adminNpsScoreDisplay');
            const npsPeriodSelect = document.getElementById('npsPeriodSelect');
            const backToInitialFromAdminLogin = document.getElementById('backToInitialFromAdminLogin');
            const backToInitialFromAdminDashboard = document.getElementById('backToInitialFromAdminDashboard');

            // Chart containers
            const initialRatingChartContainer = document.getElementById('initialRatingChart');
            const motivatorChartContainer = document.getElementById('motivatorChart');
            const ageRangeChartContainer = document.getElementById('ageRangeChart');


            // State variables
            let selectedNPSScore = null; 
            let motivatorOptions = JSON.parse(localStorage.getItem('motivatorOptions')) || ["Conte√∫do", "Did√°tica do Facilitador", "Material de Apoio", "Interatividade", "Dura√ß√£o", "Organiza√ß√£o"];
            let currentUserId = null;
            let isAuthReady = false;

            // --- Firebase Authentication ---
            console.log("Iniciando autentica√ß√£o Firebase...");
            // Authentication setup - runs once to get current user ID
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).then(() => {
                    console.log("Autenticado com token personalizado.");
                }).catch(error => {
                    console.error("Erro na autentica√ß√£o com token personalizado:", error);
                    signInAnonymously(auth).then(() => {
                        console.log("Tentando autenticar anonimamente ap√≥s falha de token.");
                    }).catch(anonError => {
                        console.error("Erro na autentica√ß√£o an√¥nima:", anonError);
                    });
                });
            } else {
                signInAnonymously(auth).then(() => {
                    console.log("Autenticado anonimamente.");
                }).catch(error => {
                    console.error("Erro na autentica√ß√£o an√¥nima:", error);
                });
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log("Usu√°rio autenticado:", currentUserId);
                } else {
                    console.log("Nenhum usu√°rio autenticado.");
                    currentUserId = crypto.randomUUID(); // Fallback for unauthenticated
                }
                isAuthReady = true;
                console.log("isAuthReady definido como:", isAuthReady);
                // No need to call createNPSScoreOptions() or resetToInitialPage() here again,
                // as they are called on DOMContentLoaded for immediate display.
                // loadSurveyData will be called when admin dashboard is accessed.
            });

            // --- Utility Functions ---
            function showMessage(message, isError = false) {
                console.log("Exibindo mensagem:", message, "√â erro?", isError);
                messageBox.textContent = message;
                messageBox.classList.remove('bg-green-500', 'bg-red-500');
                if (isError) {
                    messageBox.classList.add('error-message-box'); 
                } else {
                    messageBox.classList.remove('error-message-box'); 
                    messageBox.classList.add('bg-green-500'); 
                }
                messageBox.style.display = 'block';
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 3000);
            }

            // Function to show a specific page and hide all others
            function showPage(pageToShow) {
                console.log("Chamando showPage para:", pageToShow.id);
                const pages = [initialPage, consentPage, detailSurveyPage, adminLoginPage, adminDashboardPage];
                pages.forEach(page => {
                    if (page === pageToShow) {
                        page.style.display = 'block';
                    } else {
                        page.style.display = 'none';
                    }
                });
            }

            // Function to reset all pages to hidden and show the initial page
            function resetToInitialPage() {
                console.log("Redefinindo para a p√°gina inicial e limpando formul√°rio.");
                showPage(initialPage); // Use the new function
                
                if (npsScoreOptions) { // Check if npsScoreOptions is defined before iterating
                    npsScoreOptions.forEach(opt => {
                        opt.classList.remove('selected'); 
                        // Re-apply original colors after deselection
                        const originalValue = parseInt(opt.dataset.value);
                        opt.classList.remove('nps-detractor', 'nps-neutral', 'nps-promoter'); // Ensure no lingering classes
                        if (originalValue >= 0 && originalValue <= 6) {
                            opt.classList.add('nps-detractor');
                        } else if (originalValue >= 7 && originalValue <= 8) {
                            opt.classList.add('nps-neutral');
                        } else if (originalValue >= 9 && originalValue <= 10) {
                            opt.classList.add('nps-promoter');
                        }
                    }); 
                }
                selectedNPSScore = null; 
                // Reset form fields on detail page as well
                document.querySelectorAll('input[name="expectativasAtendidas"]').forEach(radio => radio.checked = false);
                document.querySelectorAll('input[name="percepcaoGeral"]').forEach(radio => radio.checked = false);
                document.querySelectorAll('input[name="pontoMotivador"]').forEach(radio => radio.checked = false);
                document.querySelectorAll('input[name="ageRange"]').forEach(radio => radio.checked = false); 
                commentsTextArea.value = '';
            }

            // Function to dynamically create NPS score options
            function createNPSScoreOptions() {
                console.log("Chamando createNPSScoreOptions.");
                if (npsScaleContainer) {
                    npsScaleContainer.innerHTML = ''; // Clear existing content
                    for (let i = 0; i <= 10; i++) {
                        const div = document.createElement('div');
                        div.classList.add('nps-score-option');
                        div.dataset.value = i.toString(); // Store as string
                        div.textContent = i.toString(); // Display as string

                        // Add color classes based on NPS range
                        if (i >= 0 && i <= 6) {
                            div.classList.add('nps-detractor');
                        } else if (i >= 7 && i <= 8) {
                            div.classList.add('nps-neutral');
                        } else if (i >= 9 && i <= 10) {
                            div.classList.add('nps-promoter');
                        }

                        npsScaleContainer.appendChild(div);
                        console.log(`Adicionado bot√£o NPS: ${i}`);
                    }
                    // Re-assign npsScoreOptions after creation
                    npsScoreOptions = document.querySelectorAll('.nps-score-option');
                    console.log("Bot√µes NPS criados e event listeners anexados.");

                    // Attach event listeners to the newly created options
                    npsScoreOptions.forEach(option => {
                        option.addEventListener('click', () => {
                            console.log("Bot√£o NPS clicado:", option.dataset.value);
                            // Remove all color classes from all options first, then re-apply based on the original value
                            npsScoreOptions.forEach(opt => {
                                opt.classList.remove('selected');
                                const originalValue = parseInt(opt.dataset.value);
                                opt.classList.remove('nps-detractor', 'nps-neutral', 'nps-promoter'); // Remove all color classes
                                if (originalValue >= 0 && originalValue <= 6) {
                                    opt.classList.add('nps-detractor');
                                } else if (originalValue >= 7 && originalValue <= 8) {
                                    opt.classList.add('nps-neutral');
                                } else if (originalValue >= 9 && originalValue <= 10) {
                                    opt.classList.add('nps-promoter');
                                }
                            });
                            
                            option.classList.add('selected'); // Add selected class to the clicked one
                            // The color for the selected element will already be correct due to the re-application above
                            
                            selectedNPSScore = parseInt(option.dataset.value);

                            // Transition to the consent page
                            showPage(consentPage); // Use the new function
                            console.log('Nota selecionada:', selectedNPSScore);
                        });
                    });
                } else {
                    console.error("npsScaleContainer n√£o encontrado!");
                }
            }


            function renderMotivatorOptions() {
                console.log("Renderizando op√ß√µes de motivadores.");
                motivatorOptionsContainer.innerHTML = '';
                motivatorOptions.forEach(option => {
                    const label = document.createElement('label');
                    label.className = 'radio-option flex items-center cursor-pointer p-3 border border-gray-300 rounded-lg transition-all duration-200 hover:bg-gray-100';
                    label.innerHTML = `
                        <input type="radio" name="pontoMotivador" value="${option}" class="form-radio h-5 w-5 text-blue-600 focus:ring-blue-500 mr-2">
                        <span class="text-gray-700 text-base">${option}</span>
                    `;
                    motivatorOptionsContainer.appendChild(label);
                });
            }

            function renderEditMotivatorOptions() {
                console.log("Renderizando op√ß√µes de motivadores para edi√ß√£o.");
                currentMotivatorOptionsDiv.innerHTML = '';
                if (motivatorOptions.length === 0) {
                    currentMotivatorOptionsDiv.innerHTML = '<p class="text-gray-500">Nenhuma op√ß√£o adicionada ainda.</p>';
                    return;
                }
                motivatorOptions.forEach((option, index) => {
                    const div = document.createElement('div');
                    div.className = 'edit-option-item';
                    div.innerHTML = `
                        <span class="text-gray-700 text-base">${option}</span>
                        <button data-index="${index}" class="remove-motivator-btn bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded-md transition duration-200">Remover</button>
                    `;
                    currentMotivatorOptionsDiv.appendChild(div);
                });

                document.querySelectorAll('.remove-motivator-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        console.log("Remover motivador clicado.");
                        const index = parseInt(event.target.dataset.index);
                        motivatorOptions.splice(index, 1);
                        renderEditMotivatorOptions();
                        renderMotivatorOptions();
                        localStorage.setItem('motivatorOptions', JSON.stringify(motivatorOptions));
                    });
                });
            }

            function updateNPSGauge(score) {
                console.log("Atualizando medidor NPS com score:", score);
                // NPS is typically from -100 to +100. Our 0-10 scale maps to this.
                // 0-6 Detractors, 7-8 Neutrals, 9-10 Promoters
                // Convert to a -100 to +100 scale for the gauge display
                // If 10 is max (Promoter), 0 is min (Detractor)
                // This means score 5 is 50% on gauge (orange center)
                // So, (score / 10) * 100 will give position
                const gaugePosition = (score / 10) * 100;

                adminNpsPointer.style.left = `${gaugePosition}%`;
                adminNpsPointer.textContent = score; 
                adminNpsScoreDisplay.textContent = score; 
            }

            // Function to render bar charts
            function renderBarChart(container, data, title) {
                console.log("Renderizando gr√°fico de barras para:", title, "com dados:", data);
                container.innerHTML = ''; 
                const total = Object.values(data).reduce((sum, count) => sum + count, 0);

                if (total === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center py-4">Nenhum dado para ${title}.</p>`;
                    return;
                }

                // Sort keys numerically for initialRatingChart, otherwise alphabetically
                const sortedKeys = Object.keys(data).sort((a, b) => {
                    if (title.includes('Notas')) { 
                        return parseInt(a) - parseInt(b);
                    }
                    return a.localeCompare(b);
                });

                sortedKeys.forEach(label => {
                    const count = data[label];
                    const percentage = total > 0 ? (count / total) * 100 : 0;

                    const item = document.createElement('div');
                    item.className = 'chart-bar-item';
                    item.innerHTML = `
                        <span class="chart-bar-label">${label}</span>
                        <div class="chart-bar-bg">
                            <div class="chart-bar-fill" style="width: ${percentage.toFixed(1)}%;"></div>
                        </div>
                        <span class="chart-bar-value">${count} (${percentage.toFixed(1)}%)</span>
                    `;
                    container.appendChild(item);
                });
            }


            function loadSurveyData(period = 'all') {
                console.log("Carregando dados da pesquisa para o per√≠odo:", period);
                if (!isAuthReady) {
                    console.log("Autentica√ß√£o n√£o pronta, tentando novamente em breve...");
                    setTimeout(() => loadSurveyData(period), 500);
                    return;
                }

                surveyResultsBody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500 py-4">Carregando dados...</td></tr>';
                try {
                    let q = collection(db, `/artifacts/${appId}/public/data/surveyResponses`);

                    if (period === '7days') {
                        const sevenDaysAgo = new Date();
                        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                        q = query(q, where('timestamp', '>=', sevenDaysAgo));
                    } else if (period === '30days') {
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        q = query(q, where('timestamp', '>=', thirtyDaysAgo));
                    }

                    onSnapshot(q, (snapshot) => {
                        console.log("Dados do Firestore recebidos.");
                        surveyResultsBody.innerHTML = '';
                        const feedbacks = [];
                        let promoters = 0; 
                        let neutrals = 0;  
                        let detractors = 0; 
                        let totalResponses = 0;

                        const initialRatingCounts = {}; 
                        const motivatorCounts = {};
                        const ageRangeCounts = {};
                        const expectativasAtendidasCounts = {}; 
                        const percepcaoGeralCounts = {}; 


                        if (snapshot.empty) {
                            console.log("Nenhum dado de pesquisa encontrado para o per√≠odo selecionado.");
                            surveyResultsBody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500 py-4">Nenhum dado de pesquisa encontrado.</td></tr>';
                            updateNPSGauge(0);
                            renderBarChart(initialRatingChartContainer, {}, 'Notas (0-10)');
                            renderBarChart(motivatorChartContainer, {}, 'Pontos Motivadores');
                            renderBarChart(ageRangeChartContainer, {}, 'Faixas Et√°rias');
                            return;
                        }

                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            
                            // Ensure npsScore is treated as a number
                            const npsScore = typeof data.npsScore === 'number' ? data.npsScore : parseInt(data.npsScore) || 0;

                            feedbacks.push({
                                id: doc.id,
                                date: data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'N/A',
                                userId: data.userId || 'N/A',
                                npsScore: npsScore, 
                                expectativasAtendidas: data.expectativasAtendidas || 'N/A', 
                                percepcaoGeral: data.percepcaoGeral || 'N/A', 
                                motivator: data.pontoMotivador || 'N/A',
                                comment: data.comments || 'N/A',
                                ageRange: data.ageRange || 'N/A'
                            });

                            // Populate data for charts
                            if (npsScore !== undefined) {
                                initialRatingCounts[npsScore] = (initialRatingCounts[npsScore] || 0) + 1;
                            }
                            if (data.pontoMotivador) {
                                motivatorCounts[data.pontoMotivador] = (motivatorCounts[data.pontoMotivador] || 0) + 1;
                            }
                            if (data.ageRange) {
                                ageRangeCounts[data.ageRange] = (ageRangeCounts[data.ageRange] || 0) + 1;
                            }
                            if (data.expectativasAtendidas) {
                                expectativasAtendidasCounts[data.expectativasAtendidas] = (expectativasAtendidasCounts[data.expectativasAtendidas] || 0) + 1;
                            }
                            if (data.percepcaoGeral) {
                                percepcaoGeralCounts[data.percepcaoGeral] = (percepcaoGeralCounts[data.percepcaoGeral] || 0) + 1;
                            }

                            // Calculate NPS based on 0-10 score
                            if (npsScore >= 9) {
                                promoters++;
                            } else if (npsScore >= 7 && npsScore <= 8) {
                                neutrals++; 
                            } else if (npsScore >= 0 && npsScore <= 6) {
                                detractors++;
                            }
                            totalResponses++;
                        });

                        // Populate the table
                        feedbacks.forEach(feedback => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="py-2 px-4">${feedback.date}</td>
                                <td class="py-2 px-4">${feedback.userId}</td>
                                <td class="py-2 px-4 font-semibold">${feedback.npsScore}</td>
                                <td class="py-2 px-4">${feedback.expectativasAtendidas}</td>
                                <td class="py-2 px-4">${feedback.percepcaoGeral}</td>
                                <td class="py-2 px-4">${feedback.motivator}</td>
                                <td class="py-2 px-4">${feedback.comment}</td>
                                <td class="py-2 px-4">${feedback.ageRange}</td>
                            `;
                            surveyResultsBody.appendChild(row);
                        });

                        // Update NPS Gauge
                        if (totalResponses > 0) {
                            const nps = ((promoters - detractors) / totalResponses) * 100;
                            updateNPSGauge(Math.round(nps)); 
                        } else {
                            updateNPSGauge(0);
                        }

                        // Render charts
                        renderBarChart(initialRatingChartContainer, initialRatingCounts, 'Notas (0-10)');
                        renderBarChart(motivatorChartContainer, motivatorCounts, 'Pontos Motivadores');
                        renderBarChart(ageRangeChartContainer, ageRangeCounts, 'Faixas Et√°rias');
                        // You can add rendering for the new charts if desired
                        // renderBarChart(expectativasAtendidasChartContainer, expectativasAtendidasCounts, 'Expectativas Atendidas');
                        // renderBarChart(percepcaoGeralChartContainer, percepcaoGeralCounts, 'Percep√ß√£o Geral');

                    }, (error) => {
                        console.error("Erro ao carregar dados do Firestore:", error);
                        surveyResultsBody.innerHTML = '<tr><td colspan="8" class="text-center text-red-500 py-4">Erro ao carregar dados.</td></tr>';
                        showMessage('Erro ao carregar dados do painel de administra√ß√£o.', true);
                    });
                } catch (error) {
                    console.error("Erro ao configurar listener do Firestore:", error);
                    surveyResultsBody.innerHTML = '<tr><td colspan="8" class="text-center text-red-500 py-4">Erro ao iniciar o carregamento de dados.</td></tr>';
                    showMessage('Erro ao iniciar o carregamento de dados do painel de administra√ß√£o.', true);
                }
            }


            // --- Initial Setup (executed once DOM is loaded) ---
            createNPSScoreOptions(); // Ensures NPS numbers are visible immediately
            resetToInitialPage();   // Sets initial page visibility
            renderMotivatorOptions(); // Renders motivator options

            // --- Event Listeners ---
            consentYesBtn.addEventListener('click', () => {
                console.log("Bot√£o 'Sim' de consentimento clicado.");
                showPage(detailSurveyPage); // Use the new function
            });

            consentNoBtn.addEventListener('click', async () => {
                console.log("Bot√£o 'N√£o' de consentimento clicado.");
                // If the user doesn't want to collaborate more, send only the score and reset
                const surveyData = {
                    userId: currentUserId,
                    npsScore: selectedNPSScore,
                    timestamp: new Date(),
                    // Other optional fields can be included as 'N√£o informado'
                    expectativasAtendidas: 'N√£o informado',
                    percepcaoGeral: 'N√£o informado',
                    pontoMotivador: 'N√£o informado',
                    comments: 'N√£o informado',
                    ageRange: 'N√£o informado'
                };

                try {
                    if (isAuthReady) {
                        await addDoc(collection(db, `/artifacts/${appId}/public/data/surveyResponses`), surveyData);
                        console.log('Dados b√°sicos da Pesquisa salvos no Firestore:', surveyData);
                        showMessage('Sua avalia√ß√£o foi enviada. Obrigado!');
                    } else {
                        showMessage('Erro: Autentica√ß√£o n√£o pronta. Tente novamente.', true);
                        console.error('Erro: Autentica√ß√£o Firebase n√£o pronta.');
                        return;
                    }
                } catch (e) {
                    console.error("Erro ao adicionar documento: ", e);
                    showMessage('Erro ao enviar avalia√ß√£o. Tente novamente.', true);
                    return;
                }

                setTimeout(() => {
                    resetToInitialPage();
                }, 3000);
            });


            // Add click listener to the floating 'Acessar Painel Admin' button
            goToAdminBtnFloating.addEventListener('click', () => {
                console.log("Bot√£o 'Acessar Painel Admin' clicado.");
                showPage(adminLoginPage); // Use the new function
                adminPasswordInput.value = '';
            });

            backToInitialFromAdminLogin.addEventListener('click', () => {
                console.log("Bot√£o 'Voltar' do login admin clicado.");
                showPage(initialPage); // Use the new function
            });

            backToInitialFromAdminDashboard.addEventListener('click', () => {
                console.log("Bot√£o 'Voltar' do painel admin clicado.");
                showPage(initialPage); // Use the new function
            });

            // Logic for the "Editar Op√ß√µes" button
            editMotivatorsBtn.addEventListener('click', () => {
                console.log("Bot√£o 'Editar Op√ß√µes' clicado.");
                editMotivatorsSection.classList.toggle('hidden');
                renderEditMotivatorOptions();
            });

            // Logic to add new motivator option
            addMotivatorBtn.addEventListener('click', () => {
                console.log("Bot√£o 'Adicionar' motivador clicado.");
                const newValue = newMotivatorInput.value.trim();
                if (newValue && !motivatorOptions.includes(newValue)) {
                    motivatorOptions.push(newValue);
                    newMotivatorInput.value = '';
                    renderEditMotivatorOptions();
                    renderMotivatorOptions();
                    localStorage.setItem('motivatorOptions', JSON.stringify(motivatorOptions));
                } else if (newValue && motivatorOptions.includes(newValue)) {
                    showMessage('Esta op√ß√£o j√° existe.', true);
                } else {
                    showMessage('Por favor, digite uma op√ß√£o v√°lida.', true);
                }
            });

            // Logic to save edits (hides the edit section)
            saveMotivatorsBtn.addEventListener('click', () => {
                console.log("Bot√£o 'Salvar Edi√ß√µes' clicado.");
                editMotivatorsSection.classList.add('hidden');
                showMessage('Op√ß√µes de motivadores salvas!', false);
            });

            // Add click listener to the 'Concluir Pesquisa Detalhada' button
            submitDetailSurveyBtn.addEventListener('click', async () => {
                console.log("Bot√£o 'Concluir Pesquisa Detalhada' clicado.");
                const expectativasAtendidas = document.querySelector('input[name="expectativasAtendidas"]:checked')?.value;
                const percepcaoGeral = document.querySelector('input[name="percepcaoGeral"]:checked')?.value;
                const pontoMotivador = document.querySelector('input[name="pontoMotivador"]:checked')?.value;
                const ageRange = document.querySelector('input[name="ageRange"]:checked')?.value; 
                const comments = commentsTextArea.value.trim();

                if (!expectativasAtendidas || !percepcaoGeral || !pontoMotivador || !ageRange) { 
                    showMessage('Por favor, preencha todos os campos obrigat√≥rios antes de enviar.', true);
                    console.log("Campos obrigat√≥rios faltando.");
                    return;
                }

                const surveyData = {
                    userId: currentUserId,
                    npsScore: selectedNPSScore, 
                    expectativasAtendidas: expectativasAtendidas,
                    percepcaoGeral: percepcaoGeral,
                    pontoMotivador: pontoMotivador,
                    comments: comments,
                    ageRange: ageRange, 
                    timestamp: new Date()
                };

                try {
                    if (isAuthReady) {
                        await addDoc(collection(db, `/artifacts/${appId}/public/data/surveyResponses`), surveyData);
                        console.log('Dados da Pesquisa detalhada salvos no Firestore:', surveyData);
                        showMessage('Avalia√ß√£o detalhada enviada com sucesso!');
                    } else {
                        showMessage('Erro: Autentica√ß√£o n√£o pronta. Tente novamente.', true);
                        console.error('Erro: Autentica√ß√£o Firebase n√£o pronta.');
                        return;
                    }
                } catch (e) {
                    console.error("Erro ao adicionar documento: ", e);
                    showMessage('Erro ao enviar avalia√ß√£o. Tente novamente.', true);
                    return;
                }

                // Reset the form
                document.querySelectorAll('input[name="expectativasAtendidas"]').forEach(radio => radio.checked = false);
                document.querySelectorAll('input[name="percepcaoGeral"]').forEach(radio => radio.checked = false);
                document.querySelectorAll('input[name="pontoMotivador"]').forEach(radio => radio.checked = false);
                document.querySelectorAll('input[name="ageRange"]').forEach(radio => radio.checked = false); 
                commentsTextArea.value = '';
                selectedNPSScore = null;

                // Go back to initial page after submission
                setTimeout(() => {
                    resetToInitialPage(); 
                }, 3000);
            });

            // Admin login logic
            adminLoginBtn.addEventListener('click', () => {
                console.log("Bot√£o de login Admin clicado.");
                const password = adminPasswordInput.value;
                const correctPassword = "123";

                if (password === correctPassword) {
                    console.log("Senha correta. Acessando painel admin.");
                    showPage(adminDashboardPage); // Use the new function
                    loadSurveyData(npsPeriodSelect.value);
                } else {
                    console.log("Senha incorreta.");
                    showMessage('Senha incorreta. Tente novamente.', true);
                    adminPasswordInput.value = '';
                }
            });

            // Listener for period filter in admin panel
            npsPeriodSelect.addEventListener('change', (event) => {
                console.log("Per√≠odo NPS alterado para:", event.target.value);
                loadSurveyData(event.target.value);
            });
        });
    </script>
</body>
</html>
